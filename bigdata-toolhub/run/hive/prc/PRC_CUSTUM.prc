INCLUDE INCLUDE_HEAD.sql

CREATE OR REPLACE PROCEDURE prc_generate_limitusage_data (IN months STRING, OUT result STRING)
BEGIN

DECLARE
  v_sql      varchar(100000);
  
  --SET months = '3';
  SET result = '0';

  DBMS_OUTPUT.PUT_LINE ('prc_generate_limitusage_data START');
     
   DBMS_OUTPUT.PUT_LINE('prc_generate_limitusage_data before:=========' || v_sql);

v_sql := ' INSERT INTO TEMP_CUSTNUM_LimitUsage PARTITION(months=' || months || ')';
v_sql := v_sql||' SELECT acct.CUSTR_NBR, ';
v_sql := v_sql||'       acct.LIMIT, ';
v_sql := v_sql||'       acct.limit_add14, ';
v_sql := v_sql||'       (acct.bal + COAL (ACCA.BAL, 0)) AS bal, ';
v_sql := v_sql||'       (acct.bal_add14 + COAL (ACCA.BAL_add14, 0)) AS bal_add14 ';
v_sql := v_sql||'  FROM (  SELECT fa.CUSTR_NBR AS CUSTR_NBR, ';
v_sql := v_sql||'                 MAX (fa.LIMIT + 0) AS LIMIT, ';
v_sql := v_sql||'                 MAX (fa.limit_add14 + 0) AS limit_add14, ';
v_sql := v_sql||'                 SUM (fa.bal) AS bal, ';
v_sql := v_sql||'                 SUM (fa.bal_add14) AS bal_add14 ';
v_sql := v_sql||'            FROM (  SELECT SRC.XACCOUNT AS XACCOUNT, ';
v_sql := v_sql||'                           SRC.CUSTR_NBR AS CUSTR_NBR, ';
v_sql := v_sql||'                           ROUND ( ';
v_sql := v_sql||'                              SUM ( ';
v_sql := v_sql||'                                 CASE ';
v_sql := v_sql||'                                    WHEN src.tempDays = 0 ';
v_sql := v_sql||'                                    THEN ';
v_sql := v_sql||'                                       src.days * CRED_LIMIT ';
v_sql := v_sql||'                                    ELSE ';
v_sql := v_sql||'                                           (src.days - src.tempDays) ';
v_sql := v_sql||'                                         * src.CRED_LIMIT ';
v_sql := v_sql||'                                       + src.tempDays * src.TEMP_LIMIT ';
v_sql := v_sql||'                                 END), ';
v_sql := v_sql||'                              4) ';
v_sql := v_sql||'                              LIMIT, ';
v_sql := v_sql||'                             ROUND ( ';
v_sql := v_sql||'                                SUM ( ';
v_sql := v_sql||'                                   CASE ';
v_sql := v_sql||'                                      WHEN src.tempDays = 0 ';
v_sql := v_sql||'                                      THEN ';
v_sql := v_sql||'                                         src.days * CRED_LIMIT ';
v_sql := v_sql||'                                      ELSE ';
v_sql := v_sql||'                                             (src.days - src.tempDays) ';
v_sql := v_sql||'                                           * src.CRED_LIMIT ';
v_sql := v_sql||'                                         + src.tempDays * src.TEMP_LIMIT ';
v_sql := v_sql||'                                   END), ';
v_sql := v_sql||'                                4) ';
v_sql := v_sql||'                           + COAL(ROUND (SUM (src.MP_L_LMT * days), 4),0) ';
v_sql := v_sql||'                              LIMIT_ADD14, ';
v_sql := v_sql||'                           ROUND (SUM (BAL * days), 4) BAL, ';
v_sql := v_sql||'                           ROUND (SUM (BAL_ADD14 * days), 4) BAL_ADD14 ';
v_sql := v_sql||'                      FROM (SELECT S.XACCOUNT XACCOUNT, ';
v_sql := v_sql||'                                   S.CUSTR_NBR CUSTR_NBR, ';
v_sql := v_sql||'                                   floor (CASE ';
v_sql := v_sql||'                                   WHEN S.TLMT_END = ''0'' THEN 0 ';
v_sql := v_sql||'                                   WHEN (S.TLMT_END + 0) <= S.TLMT_BEG THEN 0 ';
v_sql := v_sql||'                                      WHEN     (S.TLMT_BEG + 0) <= ';
v_sql := v_sql||'                                                     toDate(S.END_DATE, ';
v_sql := v_sql||'                                                              ''yyyymmdd'') ';
v_sql := v_sql||'                                           AND (S.TLMT_END + 0) > ';
v_sql := v_sql||'                                                     toDate(S.END_DATE, ';
v_sql := v_sql||'                                                              ''yyyymmdd'') ';
v_sql := v_sql||'                                      THEN ';
v_sql := v_sql||'                                           S.END_DATE ';
v_sql := v_sql||'                                         - CASE ';
v_sql := v_sql||'                                              WHEN (S.START_DATE + 0) <= ';
v_sql := v_sql||'                                                      toDate(S.TLMT_BEG, ';
v_sql := v_sql||'                                                               ''yyyymmdd'') ';
v_sql := v_sql||'                                              THEN ';
v_sql := v_sql||'                                                 toDate(S.TLMT_BEG, ';
v_sql := v_sql||'                                                          ''yyyymmdd'') ';
v_sql := v_sql||'                                              ELSE ';
v_sql := v_sql||'                                                 CASE ';
v_sql := v_sql||'                                                    WHEN todate(S.START_DATE,''yyyy-mm-dd'') > ';
v_sql := v_sql||'                                                            ADD_MONTHS ( ';
v_sql := v_sql||'                                                               SYSDATE(), ';
v_sql := v_sql||'                                                               -' || months || ') ';
v_sql := v_sql||'                                                    THEN ';
v_sql := v_sql||'                                                       S.START_DATE ';
v_sql := v_sql||'                                                    ELSE ';
v_sql := v_sql||'                                                       ADD_MONTHS ( ';
v_sql := v_sql||'                                                          SYSDATE(), ';
v_sql := v_sql||'                                                          -' || months || ') ';
v_sql := v_sql||'                                                 END ';
v_sql := v_sql||'                                           END ';
v_sql := v_sql||'                                       WHEN     (S.TLMT_BEG + 0) <= ';
v_sql := v_sql||'                                                             toDate(S.END_DATE, ';
v_sql := v_sql||'                                                                      ''yyyymmdd'') ';
v_sql := v_sql||'                                                   AND (S.TLMT_END + 0) <= ';
v_sql := v_sql||'                                                             toDate(S.END_DATE, ';
v_sql := v_sql||'                                                                      ''yyyymmdd'') ';
v_sql := v_sql||'                                              THEN ';
v_sql := v_sql||'                                                         toDate(S.TLMT_END, ';
v_sql := v_sql||'                                                                  ''yyyymmdd'') ';
v_sql := v_sql||'                                                 - ';
v_sql := v_sql||'                                                         CASE ';
v_sql := v_sql||'                                                                 WHEN (S.START_DATE + 0) <= ';
v_sql := v_sql||'                                                                         toDate(S.TLMT_BEG, ';
v_sql := v_sql||'                                                                                  ''yyyymmdd'') ';
v_sql := v_sql||'                                                                 THEN ';
v_sql := v_sql||'                                                                    toDate(S.TLMT_BEG, ';
v_sql := v_sql||'                                                                             ''yyyymmdd'') ';
v_sql := v_sql||'                                                                 ELSE ';
v_sql := v_sql||'                                                                    CASE ';
v_sql := v_sql||'                                                                       WHEN todate(S.START_DATE,''yyyy-mm-dd'') > ';
v_sql := v_sql||'                                                                               ADD_MONTHS ( ';
v_sql := v_sql||'                                                                                  SYSDATE(), ';
v_sql := v_sql||'                                                                                  -' || months || ') ';
v_sql := v_sql||'                                                                       THEN ';
v_sql := v_sql||'                                                                          S.START_DATE ';
v_sql := v_sql||'                                                                       ELSE ';
v_sql := v_sql||'                                                                          ADD_MONTHS ( ';
v_sql := v_sql||'                                                                             SYSDATE(), ';
v_sql := v_sql||'                                                                             -' || months || ') ';
v_sql := v_sql||'                                                                    END ';
v_sql := v_sql||'                                                          END ';
v_sql := v_sql||'                                          ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                   END ';
v_sql := v_sql||'                                    )  tempDays, ';
v_sql := v_sql||'                                   S.TEMP_LIMIT TEMP_LIMIT, ';
v_sql := v_sql||'                                   S.CRED_LIMIT CRED_LIMIT, ';
v_sql := v_sql||'                                   A.MP_L_LMT MP_L_LMT, ';
v_sql := v_sql||'                                   date_diff(  S.END_DATE ';
v_sql := v_sql||'                                   , CASE ';
v_sql := v_sql||'                                        WHEN todate(S.START_DATE,''yyyy-mm-dd'') < ';
v_sql := v_sql||'                                                ADD_MONTHS (SYSDATE(), ';
v_sql := v_sql||'                                                            -' || months || ') ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           ADD_MONTHS (SYSDATE(), -' || months || ') ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           todate(S.START_DATE,''yyyy-mm-dd'') ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                     ) days, ';
v_sql := v_sql||'                                     COAL (S.STM_BALFRE, 0) ';
v_sql := v_sql||'                                   + ';
v_sql := v_sql||'                                    CASE ';
v_sql := v_sql||'                                        WHEN S.STMBALINTFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.STM_BALINT ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + COAL (S.STM_BALMP, 0) ';
v_sql := v_sql||'                                   + COAL (S.STM_BALORI, 0) ';
v_sql := v_sql||'                                   + COAL (S.STM_NOINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_CMPINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_FREE, 0) ';
v_sql := v_sql||'                                   + CASE ';
v_sql := v_sql||'                                        WHEN S.BAL_INTFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.BAL_INT ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + CASE ';
v_sql := v_sql||'                                        WHEN S.BAL_MPFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.BAL_MP ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + COAL (S.BAL_ORINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_NOINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.Auths_Amt, 0) ';
v_sql := v_sql||'                                   + COAL (S.MP_REM_PPL, 0) ';
v_sql := v_sql||'                                   + COAL (A.MP_BAL, 0) ';
v_sql := v_sql||'                                   + COAL (S.MP_AUTHS, 0) ';
v_sql := v_sql||'                                   + COAL (A.MP_AUTHS, 0) ';
v_sql := v_sql||'                                      AS BAL_ADD14, ';
v_sql := v_sql||'                                     COAL (S.STM_BALFRE, 0) ';
v_sql := v_sql||'                                   + ';
v_sql := v_sql||'                                    CASE ';
v_sql := v_sql||'                                        WHEN S.STMBALINTFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.STM_BALINT ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + COAL (S.STM_BALMP, 0) ';
v_sql := v_sql||'                                   + COAL (S.STM_BALORI, 0) ';
v_sql := v_sql||'                                   + COAL (S.STM_NOINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_CMPINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_FREE, 0) ';
v_sql := v_sql||'                                   + CASE ';
v_sql := v_sql||'                                        WHEN S.BAL_INTFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.BAL_INT ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + CASE ';
v_sql := v_sql||'                                        WHEN S.BAL_MPFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.BAL_MP ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + COAL (S.BAL_ORINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_NOINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.Auths_Amt, 0) ';
v_sql := v_sql||'                                   + COAL (S.MP_REM_PPL, 0) ';
v_sql := v_sql||'                                   + COAL (S.MP_AUTHS, 0) ';
v_sql := v_sql||'                                      AS BAL ';
v_sql := v_sql||'                              FROM (select t.* from V_FDM_S24_ACCT t left join ';
v_sql := v_sql||' (select C.code_value,C.bank_id from ccam_codes C, tbl_banks B  where B.bankid = C.bank_id and  C.code_type = ''TSZH'') ta ';
v_sql := v_sql||'                              on t.CATEGORY = ta.code_value where ta.bank_id is null ) s ';
v_sql := v_sql||'                                   LEFT JOIN V_FDM_S24_ACCA a ';
v_sql := v_sql||'                                      ON     S.START_DATE = A.START_DATE ';
v_sql := v_sql||'                                         AND S.XACCOUNT = A.XACCOUNT ';
v_sql := v_sql||'                                         AND todate(A.END_DATE,''yyyy-mm-dd'') >= ';
v_sql := v_sql||'                                                ADD_MONTHS (SYSDATE(), ';
v_sql := v_sql||'                                                            -' || months || ') ';
v_sql := v_sql||'                                         AND todate(A.END_DATE,''yyyy-mm-dd'') < date_add(sysdate(),1) ';
v_sql := v_sql||' left join (select C.code_value,C.bank_id from ccam_codes C, tbl_banks B  where B.bankid = C.bank_id and  C.code_type = ''TSCP'') tb ';
v_sql := v_sql||'                              on S.PROD_NBR = tb.code_value ';
v_sql := v_sql||'                             WHERE     todate(S.END_DATE,''yyyy-mm-dd'') >= ';
v_sql := v_sql||'                                          ADD_MONTHS (SYSDATE(), -' || months || ') ';
v_sql := v_sql||'                                   AND todate(S.END_DATE,''yyyy-mm-dd'') < date_add(sysdate(),1) ';
v_sql := v_sql||'                                   AND tb.bank_id is null ';
v_sql := v_sql||'                                                          ) src ';
v_sql := v_sql||'                  GROUP BY SRC.XACCOUNT, SRC.CUSTR_NBR) fa ';
v_sql := v_sql||'        GROUP BY fa.CUSTR_NBR) acct left join ';
v_sql := v_sql||'       (  SELECT T.CUSTR_NBR, ';
v_sql := v_sql||'                 SUM ( ';
v_sql := v_sql||'                      (    COAL (T2.STM_BALFRE, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       + ';
v_sql := v_sql||'                        CASE ';
v_sql := v_sql||'                            WHEN T2.STMBALINTFLAG = ''+'' ';
v_sql := v_sql||'                            THEN ';
v_sql := v_sql||'                                 COAL (T2.STM_BALINT, 0) ';
v_sql := v_sql||'                               * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                            ELSE ';
v_sql := v_sql||'                               0 ';
v_sql := v_sql||'                         END ';
v_sql := v_sql||'                       +   COAL (T2.STM_BALMP, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.STM_BALORI, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.STM_NOINT, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.BAL_CMPINT, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.BAL_FREE, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       + CASE ';
v_sql := v_sql||'                            WHEN T2.BALINTFLAG = ''+'' ';
v_sql := v_sql||'                            THEN ';
v_sql := v_sql||'                                 COAL (T2.BAL_INT, 0) ';
v_sql := v_sql||'                               * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                            ELSE ';
v_sql := v_sql||'                               0 ';
v_sql := v_sql||'                         END ';
v_sql := v_sql||'                       +   COAL (T2.BAL_MP, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.BAL_ORINT, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.BAL_NOINT, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.Auths_Amt, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.MP_REM_PPL, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.MP_AUTHS, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                                                    ) ';
v_sql := v_sql||'                    * (  T2.END_DATE ';
v_sql := v_sql||'                       - CASE ';
v_sql := v_sql||'                            WHEN todate(t.START_DATE,''yyyy-mm-dd'') < ';
v_sql := v_sql||'                                    ADD_MONTHS (SYSDATE(), -' || months || ') ';
v_sql := v_sql||'                            THEN ';
v_sql := v_sql||'                               ADD_MONTHS (SYSDATE(), -' || months || ') ';
v_sql := v_sql||'                            ELSE ';
v_sql := v_sql||'                               t.START_DATE ';
v_sql := v_sql||'                         END)) ';
v_sql := v_sql||'                    AS BAL_ADD14, ';
v_sql := v_sql||'                 SUM ( ';
v_sql := v_sql||'                    (    COAL (T2.STM_BALFRE, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     + ';
v_sql := v_sql||'                      CASE ';
v_sql := v_sql||'                          WHEN T2.STMBALINTFLAG = ''+'' ';
v_sql := v_sql||'                          THEN ';
v_sql := v_sql||'                               COAL (T2.STM_BALINT, 0) ';
v_sql := v_sql||'                             * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                          ELSE ';
v_sql := v_sql||'                             0 ';
v_sql := v_sql||'                       END ';
v_sql := v_sql||'                     +   COAL (T2.STM_BALMP, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.STM_BALORI, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.STM_NOINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_CMPINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_FREE, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     + CASE ';
v_sql := v_sql||'                          WHEN T2.BALINTFLAG = ''+'' ';
v_sql := v_sql||'                          THEN ';
v_sql := v_sql||'                               COAL (T2.BAL_INT, 0) ';
v_sql := v_sql||'                             * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                          ELSE ';
v_sql := v_sql||'                             0 ';
v_sql := v_sql||'                       END ';
v_sql := v_sql||'                     +   COAL (T2.BAL_MP, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_ORINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_NOINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.Auths_Amt, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.MP_REM_PPL, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.MP_AUTHS, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       * (  T2.END_DATE ';
v_sql := v_sql||'                          - CASE ';
v_sql := v_sql||'                               WHEN todate(t.START_DATE,''yyyy-mm-dd'') < ';
v_sql := v_sql||'                                       ADD_MONTHS (SYSDATE(), -' || months || ') ';
v_sql := v_sql||'                               THEN ';
v_sql := v_sql||'                                  ADD_MONTHS (SYSDATE(), -' || months || ') ';
v_sql := v_sql||'                               ELSE ';
v_sql := v_sql||'                                  t.START_DATE ';
v_sql := v_sql||'                            END))) ';
v_sql := v_sql||'                    AS BAL ';
v_sql := v_sql||'            FROM V_FDM_S24_ACCX T2 ';
v_sql := v_sql||'                 INNER JOIN FDM_S24_CUR_ACCT t ';
v_sql := v_sql||'                    ON t.XACCOUNT = T2.XACCOUNT ';
v_sql := v_sql||'                 LEFT JOIN V_PRMXR B ';
v_sql := v_sql||'                    ON T2.BANK = B.BANK AND T2.CURR_NUM = B.CURR_NUM ';
v_sql := v_sql||' LEFT JOIN (select C.code_value,C.bank_id from ccam_codes C, tbl_banks B  where B.bankid = C.bank_id and  C.code_type = ''TSZH'') tc';
v_sql := v_sql||'                    ON T2.CATEGORY = tc.code_value ';
v_sql := v_sql||'           WHERE     todate(T2.END_DATE,''yyyy-mm-dd'') >= ADD_MONTHS (SYSDATE(), -' || months || ') ';
v_sql := v_sql||'                 AND todate(T2.END_DATE,''yyyy-mm-dd'') < date_add(sysdate(),1) ';
v_sql := v_sql||'                 AND tc.bank_id is null ';
v_sql := v_sql||'        GROUP BY T.CUSTR_NBR) acca on ACCT.CUSTR_NBR = acca.CUSTR_NBR ';

    DBMS_OUTPUT.PUT_LINE('prc_generate_limitusage_data after:==========' || v_sql);
  
    execute immediate v_sql;

    SET result = '1';
  
    DBMS_OUTPUT.PUT_LINE('prc_generate_limitusage_data over:==========success!');

--EXCEPTION WHEN OTHERS THEN
 -- DBMS_OUTPUT.PUT_LINE('prc_generate_limitusage_data Error');
END;

CREATE OR REPLACE PROCEDURE prc_generate_limitusage_data_1 (IN YWDATE STRING, OUT result STRING)
BEGIN

DECLARE
  v_sql      varchar(100000);
  
  --SET YWDATE = '2016-05-17';
  DBMS_OUTPUT.PUT_LINE ('YWDATE ===' || YWDATE);
  SET result = '0';

  DBMS_OUTPUT.PUT_LINE ('prc_generate_limitusage_data_1 START');
     
   DBMS_OUTPUT.PUT_LINE('prc_generate_limitusage_data_1 before:=========' || v_sql);

v_sql := ' INSERT INTO TEMP_CUSTNUM_LimitUsage_1 ';
v_sql := v_sql||' SELECT acct.CUSTR_NBR, ';
v_sql := v_sql||'       acct.LIMIT, ';
v_sql := v_sql||'       acct.limit_add14, ';
v_sql := v_sql||'       (acct.bal + COAL (ACCA.BAL, 0)) AS bal, ';
v_sql := v_sql||'       (acct.bal_add14 + COAL (ACCA.BAL_add14, 0)) AS bal_add14, ';
v_sql := v_sql||'       (acct.BAL_WO_AUTHS + COAL (ACCA.BAL_WO_AUTHS, 0)) AS BAL_WO_AUTHS, ';
v_sql := v_sql||'       date_diff(toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), ';
v_sql := v_sql||'       ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''),-1)) ';
v_sql := v_sql||' FROM (  SELECT fa.CUSTR_NBR AS CUSTR_NBR, ';
v_sql := v_sql||'                 MAX (fa.LIMIT + 0) AS LIMIT, ';
v_sql := v_sql||'                 MAX (fa.limit_add14 + 0) AS limit_add14, ';
v_sql := v_sql||'                 SUM (fa.bal) AS bal, ';
v_sql := v_sql||'                 SUM (fa.bal_add14) AS bal_add14, ';
v_sql := v_sql||'                 SUM (fa.BAL_WO_AUTHS) AS BAL_WO_AUTHS ';
v_sql := v_sql||'            FROM (  SELECT SRC.XACCOUNT AS XACCOUNT, ';
v_sql := v_sql||'                           SRC.CUSTR_NBR AS CUSTR_NBR, ';
v_sql := v_sql||'                           ROUND ( ';
v_sql := v_sql||'                              SUM ( ';
v_sql := v_sql||'                                 CASE ';
v_sql := v_sql||'                                    WHEN src.tempDays = 0 ';
v_sql := v_sql||'                                    THEN ';
v_sql := v_sql||'                                       src.days * CRED_LIMIT ';
v_sql := v_sql||'                                    ELSE ';
v_sql := v_sql||'                                           (src.days - src.tempDays) ';
v_sql := v_sql||'                                         * src.CRED_LIMIT ';
v_sql := v_sql||'                                       + src.tempDays * src.TEMP_LIMIT ';
v_sql := v_sql||'                                 END), ';
v_sql := v_sql||'                              4) ';
v_sql := v_sql||'                              LIMIT, ';
v_sql := v_sql||'                             ROUND ( ';
v_sql := v_sql||'                                SUM ( ';
v_sql := v_sql||'                                   CASE ';
v_sql := v_sql||'                                      WHEN src.tempDays = 0 ';
v_sql := v_sql||'                                      THEN ';
v_sql := v_sql||'                                         src.days * CRED_LIMIT ';
v_sql := v_sql||'                                      ELSE ';
v_sql := v_sql||'                                             (src.days - src.tempDays) ';
v_sql := v_sql||'                                           * src.CRED_LIMIT ';
v_sql := v_sql||'                                         + src.tempDays * src.TEMP_LIMIT ';
v_sql := v_sql||'                                   END), ';
v_sql := v_sql||'                                4) ';
v_sql := v_sql||'                           + COAL(ROUND (SUM (src.MP_L_LMT * days), 4),0) ';
v_sql := v_sql||'                              LIMIT_ADD14, ';
v_sql := v_sql||'                           ROUND (SUM (BAL * days), 4) BAL, ';
v_sql := v_sql||'                           ROUND (SUM (BAL_ADD14 * days), 4) BAL_ADD14, ';
v_sql := v_sql||'                           ROUND (SUM (BAL_WO_AUTHS * days), 4) BAL_WO_AUTHS ';
v_sql := v_sql||'                      FROM (SELECT S.XACCOUNT XACCOUNT, ';
v_sql := v_sql||'                                   S.CUSTR_NBR CUSTR_NBR, ';
v_sql := v_sql||'                                   floor (CASE ';
v_sql := v_sql||'                                   WHEN S.TLMT_END = ''0'' THEN 0 ';
v_sql := v_sql||'                                   WHEN (S.TLMT_END + 0) <= S.TLMT_BEG THEN 0 ';
v_sql := v_sql||'                                      WHEN     (S.TLMT_BEG + 0) <= ';
v_sql := v_sql||'                                                     toDate(S.END_DATE, ';
v_sql := v_sql||'                                                              ''yyyymmdd'') ';
v_sql := v_sql||'                                           AND (S.TLMT_END + 0) > ';
v_sql := v_sql||'                                                     toDate(S.END_DATE, ';
v_sql := v_sql||'                                                              ''yyyymmdd'') ';
v_sql := v_sql||'                                      THEN ';
v_sql := v_sql||'                                           todate(S.END_DATE,''yyyy-mm-dd'') ';
v_sql := v_sql||'                                         - CASE ';
v_sql := v_sql||'                                              WHEN (S.START_DATE + 0) <= ';
v_sql := v_sql||'                                                      toDate(S.TLMT_BEG, ';
v_sql := v_sql||'                                                               ''yyyymmdd'') ';
v_sql := v_sql||'                                              THEN ';
v_sql := v_sql||'                                                 toDate(S.TLMT_BEG, ';
v_sql := v_sql||'                                                          ''yyyymmdd'') ';
v_sql := v_sql||'                                              ELSE ';
v_sql := v_sql||'                                                 CASE ';
v_sql := v_sql||'                                                    WHEN todate(S.START_DATE,''yyyy-mm-dd'') > ';
v_sql := v_sql||'                                                            ADD_MONTHS ( ';
v_sql := v_sql||'                                                               toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), ';
v_sql := v_sql||'                                                               -1) ';
v_sql := v_sql||'                                                    THEN ';
v_sql := v_sql||'                                                       todate(S.START_DATE,''yyyy-mm-dd'') ';
v_sql := v_sql||'                                                    ELSE ';
v_sql := v_sql||'                                                       ADD_MONTHS ( ';
v_sql := v_sql||'                                                          toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), ';
v_sql := v_sql||'                                                          -1) ';
v_sql := v_sql||'                                                 END ';
v_sql := v_sql||'                                           END ';
v_sql := v_sql||'                                       WHEN     (S.TLMT_BEG + 0) <= ';
v_sql := v_sql||'                                                             toDate(S.END_DATE, ';
v_sql := v_sql||'                                                                      ''yyyymmdd'') ';
v_sql := v_sql||'                                                   AND (S.TLMT_END + 0) <= ';
v_sql := v_sql||'                                                             toDate(S.END_DATE, ';
v_sql := v_sql||'                                                                      ''yyyymmdd'') ';
v_sql := v_sql||'                                              THEN ';
v_sql := v_sql||'                                                         date_diff(toDate(S.TLMT_END, ';
v_sql := v_sql||'                                                                  ''yyyymmdd'') ';
v_sql := v_sql||'                                                 , ';
v_sql := v_sql||'                                                         CASE ';
v_sql := v_sql||'                                                                 WHEN (S.START_DATE + 0) <= ';
v_sql := v_sql||'                                                                         toDate(S.TLMT_BEG, ';
v_sql := v_sql||'                                                                                  ''yyyymmdd'') ';
v_sql := v_sql||'                                                                 THEN ';
v_sql := v_sql||'                                                                    toDate(S.TLMT_BEG, ';
v_sql := v_sql||'                                                                             ''yyyymmdd'') ';
v_sql := v_sql||'                                                                 ELSE ';
v_sql := v_sql||'                                                                    CASE ';
v_sql := v_sql||'                                                                       WHEN todate(S.START_DATE,''yyyy-mm-dd'') > ';
v_sql := v_sql||'                                                                               ADD_MONTHS ( ';
v_sql := v_sql||'                                                                                  toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), ';
v_sql := v_sql||'                                                                                  -1) ';
v_sql := v_sql||'                                                                       THEN ';
v_sql := v_sql||'                                                                          todate(S.START_DATE,''yyyy-mm-dd'') ';
v_sql := v_sql||'                                                                       ELSE ';
v_sql := v_sql||'                                                                          ADD_MONTHS ( ';
v_sql := v_sql||'                                                                             toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), ';
v_sql := v_sql||'                                                                             -1) ';
v_sql := v_sql||'                                                                    END ';
v_sql := v_sql||'                                                          END) ';
v_sql := v_sql||'                                          ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                   END ';
v_sql := v_sql||'                                    )  tempDays, ';
v_sql := v_sql||'                                   S.TEMP_LIMIT TEMP_LIMIT, ';
v_sql := v_sql||'                                   S.CRED_LIMIT CRED_LIMIT, ';
v_sql := v_sql||'                                   A.MP_L_LMT MP_L_LMT, ';
v_sql := v_sql||'                                  date_diff (   S.END_DATE ';
v_sql := v_sql||'                                   , CASE ';
v_sql := v_sql||'                                        WHEN todate(S.START_DATE,''yyyy-mm-dd'') < ';
v_sql := v_sql||'                                                ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), ';
v_sql := v_sql||'                                                            -1) ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           todate(S.START_DATE,''yyyy-mm-dd'') ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                      ) days, ';
v_sql := v_sql||'                                     COAL (S.STM_BALFRE, 0) ';
v_sql := v_sql||'                                   + ';
v_sql := v_sql||'                                    CASE ';
v_sql := v_sql||'                                        WHEN S.STMBALINTFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.STM_BALINT ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + COAL (S.STM_BALMP, 0) ';
v_sql := v_sql||'                                   + COAL (S.STM_BALORI, 0) ';
v_sql := v_sql||'                                   + COAL (S.STM_NOINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_CMPINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_FREE, 0) ';
v_sql := v_sql||'                                   + CASE ';
v_sql := v_sql||'                                        WHEN S.BAL_INTFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.BAL_INT ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + CASE ';
v_sql := v_sql||'                                        WHEN S.BAL_MPFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.BAL_MP ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + COAL (S.BAL_ORINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_NOINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.Auths_Amt, 0) ';
v_sql := v_sql||'                                   + COAL (S.MP_REM_PPL, 0) ';
v_sql := v_sql||'                                   + COAL (A.MP_BAL, 0) ';
v_sql := v_sql||'                                   + COAL (S.MP_AUTHS, 0) ';
v_sql := v_sql||'                                   + COAL (A.MP_AUTHS, 0) ';
v_sql := v_sql||'                                      AS BAL_ADD14, ';
v_sql := v_sql||'                                     COAL (S.STM_BALFRE, 0) ';
v_sql := v_sql||'                                   + ';
v_sql := v_sql||'                                    CASE ';
v_sql := v_sql||'                                        WHEN S.STMBALINTFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.STM_BALINT ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + COAL (S.STM_BALMP, 0) ';
v_sql := v_sql||'                                   + COAL (S.STM_BALORI, 0) ';
v_sql := v_sql||'                                   + COAL (S.STM_NOINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_CMPINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_FREE, 0) ';
v_sql := v_sql||'                                   + CASE ';
v_sql := v_sql||'                                        WHEN S.BAL_INTFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.BAL_INT ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + CASE ';
v_sql := v_sql||'                                        WHEN S.BAL_MPFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.BAL_MP ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + COAL (S.BAL_ORINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_NOINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.Auths_Amt, 0) ';
v_sql := v_sql||'                                   + COAL (S.MP_REM_PPL, 0) ';
v_sql := v_sql||'                                   + COAL (S.MP_AUTHS, 0) ';
v_sql := v_sql||'                                      AS BAL , ';
v_sql := v_sql||'                                    COAL (S.STM_BALFRE, 0) ';
v_sql := v_sql||'                                   + ';
v_sql := v_sql||'                                    CASE ';
v_sql := v_sql||'                                        WHEN S.STMBALINTFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.STM_BALINT ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + COAL (S.STM_BALMP, 0) ';
v_sql := v_sql||'                                   + COAL (S.STM_BALORI, 0) ';
v_sql := v_sql||'                                   + COAL (S.STM_NOINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_CMPINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_FREE, 0) ';
v_sql := v_sql||'                                   + CASE ';
v_sql := v_sql||'                                        WHEN S.BAL_INTFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.BAL_INT ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + CASE ';
v_sql := v_sql||'                                        WHEN S.BAL_MPFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.BAL_MP ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + COAL (S.BAL_ORINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_NOINT, 0) ';
v_sql := v_sql||'                                      AS BAL_WO_AUTHS ';
v_sql := v_sql||'                              FROM (select t.* from V_FDM_S24_ACCT t left join  ';
v_sql := v_sql||' (select C.code_value,C.bank_id from ccam_codes C, tbl_banks B  where B.bankid = C.bank_id and  C.code_type = ''TSZH'') ta ';
v_sql := v_sql||'                              on t.CATEGORY = ta.code_value where ta.bank_id is null ) s';
v_sql := v_sql||'                                   LEFT JOIN V_FDM_S24_ACCA a ';
v_sql := v_sql||'                                      ON     S.START_DATE = A.START_DATE ';
v_sql := v_sql||'                                         AND S.XACCOUNT = A.XACCOUNT ';
v_sql := v_sql||'                                         AND todate(A.END_DATE,''yyyy-mm-dd'') >= ';
v_sql := v_sql||'                                                ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), ';
v_sql := v_sql||'                                                            -1) ';
v_sql := v_sql||'                                         AND todate(A.END_DATE,''yyyy-mm-dd'') < date_add(toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), 1) ';
v_sql := v_sql||' left join (select C.code_value,C.bank_id from ccam_codes C, tbl_banks B  where B.bankid = C.bank_id and  C.code_type = ''TSCP'') tb';
v_sql := v_sql||'                                      ON     S.PROD_NBR = tb.code_value ';
v_sql := v_sql||'                             WHERE     todate(S.END_DATE,''yyyy-mm-dd'') >= ';
v_sql := v_sql||'                                          ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                                   AND todate(S.END_DATE,''yyyy-mm-dd'') < date_add(toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), 1) ';
v_sql := v_sql||'                                   AND tb.bank_id is null';
v_sql := v_sql||'                                                          ) src ';
v_sql := v_sql||'                  GROUP BY SRC.XACCOUNT, SRC.CUSTR_NBR) fa ';
v_sql := v_sql||'        GROUP BY fa.CUSTR_NBR) acct left join  ';
v_sql := v_sql||'       (  SELECT T.CUSTR_NBR, ';
v_sql := v_sql||'                 SUM ( ';
v_sql := v_sql||'                      (    COAL (T2.STM_BALFRE, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       + ';
v_sql := v_sql||'                        CASE ';
v_sql := v_sql||'                            WHEN T2.STMBALINTFLAG = ''+'' ';
v_sql := v_sql||'                            THEN ';
v_sql := v_sql||'                                 COAL (T2.STM_BALINT, 0) ';
v_sql := v_sql||'                               * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                            ELSE ';
v_sql := v_sql||'                               0 ';
v_sql := v_sql||'                         END ';
v_sql := v_sql||'                       +   COAL (T2.STM_BALMP, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.STM_BALORI, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.STM_NOINT, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.BAL_CMPINT, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.BAL_FREE, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       + CASE ';
v_sql := v_sql||'                            WHEN T2.BALINTFLAG = ''+'' ';
v_sql := v_sql||'                            THEN ';
v_sql := v_sql||'                                 COAL (T2.BAL_INT, 0) ';
v_sql := v_sql||'                               * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                            ELSE ';
v_sql := v_sql||'                               0 ';
v_sql := v_sql||'                         END ';
v_sql := v_sql||'                       +   COAL (T2.BAL_MP, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.BAL_ORINT, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.BAL_NOINT, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.Auths_Amt, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.MP_REM_PPL, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.MP_AUTHS, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                                                    ) ';
v_sql := v_sql||'                    * (  T2.END_DATE ';
v_sql := v_sql||'                       - CASE ';
v_sql := v_sql||'                            WHEN todate(t.START_DATE,''yyyy-mm-dd'') < ';
v_sql := v_sql||'                                    ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                            THEN ';
v_sql := v_sql||'                               ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                            ELSE ';
v_sql := v_sql||'                               t.START_DATE ';
v_sql := v_sql||'                         END)) ';
v_sql := v_sql||'                    AS BAL_ADD14, ';
v_sql := v_sql||'                 SUM ( ';
v_sql := v_sql||'                    (    COAL (T2.STM_BALFRE, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     + ';
v_sql := v_sql||'                      CASE ';
v_sql := v_sql||'                          WHEN T2.STMBALINTFLAG = ''+'' ';
v_sql := v_sql||'                          THEN ';
v_sql := v_sql||'                               COAL (T2.STM_BALINT, 0) ';
v_sql := v_sql||'                             * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                          ELSE ';
v_sql := v_sql||'                             0 ';
v_sql := v_sql||'                       END ';
v_sql := v_sql||'                     +   COAL (T2.STM_BALMP, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.STM_BALORI, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.STM_NOINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_CMPINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_FREE, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     + CASE ';
v_sql := v_sql||'                          WHEN T2.BALINTFLAG = ''+'' ';
v_sql := v_sql||'                          THEN ';
v_sql := v_sql||'                               COAL (T2.BAL_INT, 0) ';
v_sql := v_sql||'                             * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                          ELSE ';
v_sql := v_sql||'                             0 ';
v_sql := v_sql||'                       END ';
v_sql := v_sql||'                     +   COAL (T2.BAL_MP, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_ORINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_NOINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.Auths_Amt, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.MP_REM_PPL, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.MP_AUTHS, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       * (  date_diff(T2.END_DATE ';
v_sql := v_sql||'                          , CASE ';
v_sql := v_sql||'                               WHEN todate(t.START_DATE,''yyyy-mm-dd'') < ';
v_sql := v_sql||'                                       ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                               THEN ';
v_sql := v_sql||'                                  ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                               ELSE ';
v_sql := v_sql||'                                  todate(t.START_DATE,''yyyy-mm-dd'') ';
v_sql := v_sql||'                            END)))) ';
v_sql := v_sql||'                    AS BAL , ';
v_sql := v_sql||'                                            SUM ( ';
v_sql := v_sql||'                    (    COAL (T2.STM_BALFRE, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     + ';
v_sql := v_sql||'                      CASE ';
v_sql := v_sql||'                          WHEN T2.STMBALINTFLAG = ''+'' ';
v_sql := v_sql||'                          THEN ';
v_sql := v_sql||'                               COAL (T2.STM_BALINT, 0) ';
v_sql := v_sql||'                             * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                          ELSE ';
v_sql := v_sql||'                             0 ';
v_sql := v_sql||'                       END ';
v_sql := v_sql||'                     +   COAL (T2.STM_BALMP, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.STM_BALORI, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.STM_NOINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_CMPINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_FREE, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     + CASE ';
v_sql := v_sql||'                          WHEN T2.BALINTFLAG = ''+'' ';
v_sql := v_sql||'                          THEN ';
v_sql := v_sql||'                               COAL (T2.BAL_INT, 0) ';
v_sql := v_sql||'                             * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                          ELSE ';
v_sql := v_sql||'                             0 ';
v_sql := v_sql||'                       END ';
v_sql := v_sql||'                     +   COAL (T2.BAL_MP, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_ORINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_NOINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.Auths_Amt, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.MP_REM_PPL, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.MP_AUTHS, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       * (  T2.END_DATE ';
v_sql := v_sql||'                          - CASE ';
v_sql := v_sql||'                               WHEN todate(t.START_DATE,''yyyy-mm-dd'') < ';
v_sql := v_sql||'                                       ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                               THEN ';
v_sql := v_sql||'                                  ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                               ELSE ';
v_sql := v_sql||'                                  t.START_DATE ';
v_sql := v_sql||'                            END))) ';
v_sql := v_sql||'                    AS BAL_WO_AUTHS ';
v_sql := v_sql||'            FROM V_FDM_S24_ACCX T2 ';
v_sql := v_sql||'                 INNER JOIN FDM_S24_CUR_ACCT t ';
v_sql := v_sql||'                    ON t.XACCOUNT = T2.XACCOUNT ';
v_sql := v_sql||'                 LEFT JOIN V_PRMXR B ';
v_sql := v_sql||'                    ON T2.BANK = B.BANK AND T2.CURR_NUM = B.CURR_NUM ';
v_sql := v_sql||' LEFT JOIN (select C.code_value,C.bank_id from ccam_codes C, tbl_banks B  where B.bankid = C.bank_id and  C.code_type = ''TSZH'') tc ';
v_sql := v_sql||'                    ON T2.CATEGORY = tc.code_value';
v_sql := v_sql||'           WHERE     todate(T2.END_DATE,''yyyy-mm-dd'') >= ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                 AND todate(T2.END_DATE,''yyyy-mm-dd'') < date_add(toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), 1) ';
v_sql := v_sql||'                 AND tc.bank_id is null';
v_sql := v_sql||'        GROUP BY T.CUSTR_NBR) acca on ACCT.CUSTR_NBR = acca.CUSTR_NBR ';

    DBMS_OUTPUT.PUT_LINE('prc_generate_limitusage_data1 after:==========' || v_sql);
  
    execute immediate v_sql;

    SET result = '1';
  
    DBMS_OUTPUT.PUT_LINE('prc_generate_limitusage_data1 over:==========success!');

--EXCEPTION WHEN OTHERS THEN
 -- DBMS_OUTPUT.PUT_LINE('prc_generate_limitusage_data1 Error');
END;

CREATE OR REPLACE PROCEDURE prc_generate_limitusage_data_2 (IN YWDATE STRING, OUT result STRING)
BEGIN

DECLARE
  v_sql      varchar(100000);
  
  --SET YWDATE = '2016-05-17';
  DBMS_OUTPUT.PUT_LINE ('YWDATE ===' || YWDATE);
  SET result = '0';

  DBMS_OUTPUT.PUT_LINE ('prc_generate_limitusage_data_2 START');
     
   DBMS_OUTPUT.PUT_LINE('prc_generate_limitusage_data_2 before:=========' || v_sql);
   
v_sql := ' INSERT INTO TEMP_CUSTNUM_LimitUsage_2 ';
v_sql := v_sql||' SELECT acct.CUSTR_NBR, ';
v_sql := v_sql||'       acct.LIMIT, ';
v_sql := v_sql||'       acct.limit_add14, ';
v_sql := v_sql||'       (acct.bal + COAL (ACCA.BAL, 0)) AS bal, ';
v_sql := v_sql||'       (acct.bal_add14 + COAL (ACCA.BAL_add14, 0)) AS bal_add14, ';
v_sql := v_sql||'       (acct.BAL_WO_AUTHS + COAL (ACCA.BAL_WO_AUTHS, 0)) AS BAL_WO_AUTHS, ';
v_sql := v_sql||'       date_diff(toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), ';
v_sql := v_sql||'       ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''),-1)) ';
v_sql := v_sql||'  FROM (  SELECT final.CUSTR_NBR AS CUSTR_NBR, ';
v_sql := v_sql||'                 MAX (final.LIMIT + 0) AS LIMIT, ';
v_sql := v_sql||'                 MAX (final.limit_add14 + 0) AS limit_add14, ';
v_sql := v_sql||'                 SUM (final.bal) AS bal, ';
v_sql := v_sql||'                 SUM (final.bal_add14) AS bal_add14, ';
v_sql := v_sql||'                 SUM (final.BAL_WO_AUTHS) AS BAL_WO_AUTHS ';
v_sql := v_sql||'            FROM (  SELECT SRC.XACCOUNT AS XACCOUNT, ';
v_sql := v_sql||'                           SRC.CUSTR_NBR AS CUSTR_NBR, ';
v_sql := v_sql||'                           ROUND ( ';
v_sql := v_sql||'                              SUM ( ';
v_sql := v_sql||'                                 CASE ';
v_sql := v_sql||'                                    WHEN src.tempDays = 0 ';
v_sql := v_sql||'                                    THEN ';
v_sql := v_sql||'                                       src.days * CRED_LIMIT ';
v_sql := v_sql||'                                    ELSE ';
v_sql := v_sql||'                                           (src.days - src.tempDays) ';
v_sql := v_sql||'                                         * src.CRED_LIMIT ';
v_sql := v_sql||'                                       + coal(src.tempDays * src.TEMP_LIMIT,0) ';
v_sql := v_sql||'                                 END), ';
v_sql := v_sql||'                              4) ';
v_sql := v_sql||'                              LIMIT, ';
v_sql := v_sql||'                             ROUND ( ';
v_sql := v_sql||'                                SUM ( ';
v_sql := v_sql||'                                   CASE ';
v_sql := v_sql||'                                      WHEN src.tempDays = 0 ';
v_sql := v_sql||'                                      THEN ';
v_sql := v_sql||'                                         src.days * CRED_LIMIT ';
v_sql := v_sql||'                                      ELSE ';
v_sql := v_sql||'                                             (src.days - src.tempDays) ';
v_sql := v_sql||'                                           * src.CRED_LIMIT ';
v_sql := v_sql||'                                         + coal(src.tempDays * src.TEMP_LIMIT,0) ';
v_sql := v_sql||'                                   END), ';
v_sql := v_sql||'                                4) ';
v_sql := v_sql||'                           + ROUND (SUM (src.MP_L_LMT * days), 4) ';
v_sql := v_sql||'                              LIMIT_ADD14, ';
v_sql := v_sql||'                           ROUND (SUM (BAL * days), 4) BAL, ';
v_sql := v_sql||'                           ROUND (SUM (BAL_ADD14 * days), 4) BAL_ADD14, ';
v_sql := v_sql||'                           ROUND (SUM (BAL_WO_AUTHS * days), 4) BAL_WO_AUTHS ';
v_sql := v_sql||'                      FROM (SELECT S.XACCOUNT XACCOUNT, ';
v_sql := v_sql||'                                   S.CUSTR_NBR CUSTR_NBR, ';
v_sql := v_sql||'                                   floor (CASE ';
v_sql := v_sql||'                                   WHEN S.TLMT_END = ''0'' THEN 0 ';
v_sql := v_sql||'                                   WHEN (S.TLMT_END + 0) <= S.TLMT_BEG THEN 0 ';
v_sql := v_sql||'                                      WHEN     (S.TLMT_BEG + 0) <= ';
v_sql := v_sql||'                                                     toDate(S.END_DATE, ';
v_sql := v_sql||'                                                              ''yyyymmdd'') ';
v_sql := v_sql||'                                           AND (S.TLMT_END + 0) > ';
v_sql := v_sql||'                                                     toDate(S.END_DATE, ';
v_sql := v_sql||'                                                              ''yyyymmdd'') ';
v_sql := v_sql||'                                      THEN ';
v_sql := v_sql||'                                           S.END_DATE ';
v_sql := v_sql||'                                         - CASE ';
v_sql := v_sql||'                                              WHEN (S.START_DATE + 0) <= ';
v_sql := v_sql||'                                                      toDate(S.TLMT_BEG, ';
v_sql := v_sql||'                                                               ''yyyymmdd'') ';
v_sql := v_sql||'                                              THEN ';
v_sql := v_sql||'                                                 toDate(S.TLMT_BEG, ';
v_sql := v_sql||'                                                          ''yyyymmdd'') ';
v_sql := v_sql||'                                              ELSE ';
v_sql := v_sql||'                                                 CASE ';
v_sql := v_sql||'                                                    WHEN todate(S.START_DATE,''yyyy-mm-dd'') > ';
v_sql := v_sql||'                                                            ADD_MONTHS ( ';
v_sql := v_sql||'                                                               toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), ';
v_sql := v_sql||'                                                               -1) ';
v_sql := v_sql||'                                                    THEN ';
v_sql := v_sql||'                                                       S.START_DATE ';
v_sql := v_sql||'                                                    ELSE ';
v_sql := v_sql||'                                                       ADD_MONTHS ( ';
v_sql := v_sql||'                                                          toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), ';
v_sql := v_sql||'                                                          -1) ';
v_sql := v_sql||'                                                 END ';
v_sql := v_sql||'                                           END ';
v_sql := v_sql||'                                       WHEN     (S.TLMT_BEG + 0) <= ';
v_sql := v_sql||'                                                             toDate(S.END_DATE, ';
v_sql := v_sql||'                                                                      ''yyyymmdd'') ';
v_sql := v_sql||'                                                   AND (S.TLMT_END + 0) <= ';
v_sql := v_sql||'                                                             toDate(S.END_DATE, ';
v_sql := v_sql||'                                                                      ''yyyymmdd'') ';
v_sql := v_sql||'                                              THEN ';
v_sql := v_sql||'                                                         date_diff(toDate(S.TLMT_END, ';
v_sql := v_sql||'                                                                  ''yyyymmdd'') ';
v_sql := v_sql||'                                                 , ';
v_sql := v_sql||'                                                         CASE ';
v_sql := v_sql||'                                                                 WHEN (S.START_DATE + 0) <= ';
v_sql := v_sql||'                                                                         toDate(S.TLMT_BEG, ';
v_sql := v_sql||'                                                                                  ''yyyymmdd'') ';
v_sql := v_sql||'                                                                 THEN ';
v_sql := v_sql||'                                                                    toDate(S.TLMT_BEG, ';
v_sql := v_sql||'                                                                             ''yyyymmdd'') ';
v_sql := v_sql||'                                                                 ELSE ';
v_sql := v_sql||'                                                                    CASE ';
v_sql := v_sql||'                                                                       WHEN todate(S.START_DATE,''yyyy-mm-dd'') > ';
v_sql := v_sql||'                                                                               ADD_MONTHS ( ';
v_sql := v_sql||'                                                                                  toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), ';
v_sql := v_sql||'                                                                                  -1) ';
v_sql := v_sql||'                                                                       THEN ';
v_sql := v_sql||'                                                                          todate(S.START_DATE,''yyyy-mm-dd'') ';
v_sql := v_sql||'                                                                       ELSE ';
v_sql := v_sql||'                                                                          ADD_MONTHS ( ';
v_sql := v_sql||'                                                                             toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), ';
v_sql := v_sql||'                                                                             -1) ';
v_sql := v_sql||'                                                                    END ';
v_sql := v_sql||'                                                          END) ';
v_sql := v_sql||'                                          ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                   END ';
v_sql := v_sql||'                                    )  tempDays, ';
v_sql := v_sql||'                                   S.TEMP_LIMIT TEMP_LIMIT, ';
v_sql := v_sql||'                                   S.CRED_LIMIT CRED_LIMIT, ';
v_sql := v_sql||'                                   A.MP_L_LMT MP_L_LMT, ';
v_sql := v_sql||'                                  date_diff (   todate(S.END_DATE,''yyyy-mm-dd'') ';
v_sql := v_sql||'                                   , CASE ';
v_sql := v_sql||'                                        WHEN todate(S.START_DATE,''yyyy-mm-dd'') < ';
v_sql := v_sql||'                                                ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), ';
v_sql := v_sql||'                                                            -1) ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           todate(S.START_DATE,''yyyy-mm-dd'') ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                      ) days, ';
v_sql := v_sql||'                                     COAL (S.STM_BALFRE, 0) ';
v_sql := v_sql||'                                   + ';
v_sql := v_sql||'                                    CASE ';
v_sql := v_sql||'                                        WHEN S.STMBALINTFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.STM_BALINT ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + COAL (S.STM_BALMP, 0) ';
v_sql := v_sql||'                                   + COAL (S.STM_BALORI, 0) ';
v_sql := v_sql||'                                   + COAL (S.STM_NOINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_CMPINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_FREE, 0) ';
v_sql := v_sql||'                                   + CASE ';
v_sql := v_sql||'                                        WHEN S.BAL_INTFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.BAL_INT ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + CASE ';
v_sql := v_sql||'                                        WHEN S.BAL_MPFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.BAL_MP ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + COAL (S.BAL_ORINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_NOINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.Auths_Amt, 0) ';
v_sql := v_sql||'                                   + COAL (S.MP_REM_PPL, 0) ';
v_sql := v_sql||'                                   + COAL (A.MP_BAL, 0) ';
v_sql := v_sql||'                                   + COAL (S.MP_AUTHS, 0) ';
v_sql := v_sql||'                                   + COAL (A.MP_AUTHS, 0) ';
v_sql := v_sql||'                                      AS BAL_ADD14, ';
v_sql := v_sql||'                                     COAL (S.STM_BALFRE, 0) ';
v_sql := v_sql||'                                   + ';
v_sql := v_sql||'                                    CASE ';
v_sql := v_sql||'                                        WHEN S.STMBALINTFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.STM_BALINT ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + COAL (S.STM_BALMP, 0) ';
v_sql := v_sql||'                                   + COAL (S.STM_BALORI, 0) ';
v_sql := v_sql||'                                   + COAL (S.STM_NOINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_CMPINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_FREE, 0) ';
v_sql := v_sql||'                                   + CASE ';
v_sql := v_sql||'                                        WHEN S.BAL_INTFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.BAL_INT ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + CASE ';
v_sql := v_sql||'                                        WHEN S.BAL_MPFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.BAL_MP ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + COAL (S.BAL_ORINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_NOINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.Auths_Amt, 0) ';
v_sql := v_sql||'                                   + COAL (S.MP_REM_PPL, 0) ';
v_sql := v_sql||'                                   + COAL (S.MP_AUTHS, 0) ';
v_sql := v_sql||'                                      AS BAL , ';
v_sql := v_sql||'                                    COAL (S.STM_BALFRE, 0) ';
v_sql := v_sql||'                                   + ';
v_sql := v_sql||'                                    CASE ';
v_sql := v_sql||'                                        WHEN S.STMBALINTFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.STM_BALINT ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + COAL (S.STM_BALMP, 0) ';
v_sql := v_sql||'                                   + COAL (S.STM_BALORI, 0) ';
v_sql := v_sql||'                                   + COAL (S.STM_NOINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_CMPINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_FREE, 0) ';
v_sql := v_sql||'                                   + CASE ';
v_sql := v_sql||'                                        WHEN S.BAL_INTFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.BAL_INT ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + CASE ';
v_sql := v_sql||'                                        WHEN S.BAL_MPFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.BAL_MP ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + COAL (S.BAL_ORINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_NOINT, 0) ';
v_sql := v_sql||'                                      AS BAL_WO_AUTHS ';
v_sql := v_sql||'                              FROM (select t.* from V_FDM_S24_ACCT t left join ';
v_sql := v_sql||' (select C.code_value,C.bank_id from ccam_codes C, tbl_banks B  where B.bankid = C.bank_id and  C.code_type = ''TSZH'') ta ';
v_sql := v_sql||'                              on t.CATEGORY = ta.code_value where ta.bank_id is null ) s';
v_sql := v_sql||'                                   LEFT JOIN V_FDM_S24_ACCA a ';
v_sql := v_sql||'                                      ON     S.START_DATE = A.START_DATE ';
v_sql := v_sql||'                                         AND S.XACCOUNT = A.XACCOUNT ';
v_sql := v_sql||'                                         AND todate(A.END_DATE,''yyyy-mm-dd'') >= ';
v_sql := v_sql||'                                                ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), ';
v_sql := v_sql||'                                                            -1) ';
v_sql := v_sql||'                                         AND todate(A.END_DATE,''yyyy-mm-dd'') < date_add(toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), 1) ';
v_sql := v_sql||' LEFT JOIN (select C.code_value,C.bank_id from ccam_codes C, tbl_banks B  where B.bankid = C.bank_id and  C.code_type = ''TSCP'') tb ';
v_sql := v_sql||'                                      ON     S.PROD_NBR = tb.code_value ';
v_sql := v_sql||'                             WHERE     todate(S.END_DATE,''yyyy-mm-dd'') >= ';
v_sql := v_sql||'                                          ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                                   AND todate(S.END_DATE,''yyyy-mm-dd'') < date_add(toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), 1) ';
v_sql := v_sql||'                                   AND tb.bank_id is null ';
v_sql := v_sql||'                                                          ) src ';
v_sql := v_sql||'                  GROUP BY SRC.XACCOUNT, SRC.CUSTR_NBR) final ';
v_sql := v_sql||'        GROUP BY final.CUSTR_NBR) acct left join ';
v_sql := v_sql||'       (  SELECT T.CUSTR_NBR, ';
v_sql := v_sql||'                 SUM ( ';
v_sql := v_sql||'                      (    COAL (T2.STM_BALFRE, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       + ';
v_sql := v_sql||'                        CASE ';
v_sql := v_sql||'                            WHEN T2.STMBALINTFLAG = ''+'' ';
v_sql := v_sql||'                            THEN ';
v_sql := v_sql||'                                 COAL (T2.STM_BALINT, 0) ';
v_sql := v_sql||'                               * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                            ELSE ';
v_sql := v_sql||'                               0 ';
v_sql := v_sql||'                         END ';
v_sql := v_sql||'                       +   COAL (T2.STM_BALMP, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.STM_BALORI, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.STM_NOINT, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.BAL_CMPINT, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.BAL_FREE, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       + CASE ';
v_sql := v_sql||'                            WHEN T2.BALINTFLAG = ''+'' ';
v_sql := v_sql||'                            THEN ';
v_sql := v_sql||'                                 COAL (T2.BAL_INT, 0) ';
v_sql := v_sql||'                               * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                            ELSE ';
v_sql := v_sql||'                               0 ';
v_sql := v_sql||'                         END ';
v_sql := v_sql||'                       +   COAL (T2.BAL_MP, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.BAL_ORINT, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.BAL_NOINT, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.Auths_Amt, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.MP_REM_PPL, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.MP_AUTHS, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                                                    ) ';
v_sql := v_sql||'                    * (  T2.END_DATE ';
v_sql := v_sql||'                       - CASE ';
v_sql := v_sql||'                            WHEN todate(t.START_DATE,''yyyy-mm-dd'') < ';
v_sql := v_sql||'                                    ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                            THEN ';
v_sql := v_sql||'                               ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                            ELSE ';
v_sql := v_sql||'                               t.START_DATE ';
v_sql := v_sql||'                         END)) ';
v_sql := v_sql||'                    AS BAL_ADD14, ';
v_sql := v_sql||'                 SUM ( ';
v_sql := v_sql||'                    (    COAL (T2.STM_BALFRE, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     + ';
v_sql := v_sql||'                      CASE ';
v_sql := v_sql||'                          WHEN T2.STMBALINTFLAG = ''+'' ';
v_sql := v_sql||'                          THEN ';
v_sql := v_sql||'                               COAL (T2.STM_BALINT, 0) ';
v_sql := v_sql||'                             * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                          ELSE ';
v_sql := v_sql||'                             0 ';
v_sql := v_sql||'                       END ';
v_sql := v_sql||'                     +   COAL (T2.STM_BALMP, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.STM_BALORI, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.STM_NOINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_CMPINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_FREE, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     + CASE ';
v_sql := v_sql||'                          WHEN T2.BALINTFLAG = ''+'' ';
v_sql := v_sql||'                          THEN ';
v_sql := v_sql||'                               COAL (T2.BAL_INT, 0) ';
v_sql := v_sql||'                             * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                          ELSE ';
v_sql := v_sql||'                             0 ';
v_sql := v_sql||'                       END ';
v_sql := v_sql||'                     +   COAL (T2.BAL_MP, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_ORINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_NOINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.Auths_Amt, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.MP_REM_PPL, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.MP_AUTHS, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       * (  T2.END_DATE ';
v_sql := v_sql||'                          - CASE ';
v_sql := v_sql||'                               WHEN todate(t.START_DATE,''yyyy-mm-dd'') < ';
v_sql := v_sql||'                                       ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                               THEN ';
v_sql := v_sql||'                                  ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                               ELSE ';
v_sql := v_sql||'                                  t.START_DATE ';
v_sql := v_sql||'                            END))) ';
v_sql := v_sql||'                    AS BAL , ';
v_sql := v_sql||'                                            SUM ( ';
v_sql := v_sql||'                    (    COAL (T2.STM_BALFRE, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     + ';
v_sql := v_sql||'                      CASE ';
v_sql := v_sql||'                          WHEN T2.STMBALINTFLAG = ''+'' ';
v_sql := v_sql||'                          THEN ';
v_sql := v_sql||'                               COAL (T2.STM_BALINT, 0) ';
v_sql := v_sql||'                             * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                          ELSE ';
v_sql := v_sql||'                             0 ';
v_sql := v_sql||'                       END ';
v_sql := v_sql||'                     +   COAL (T2.STM_BALMP, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.STM_BALORI, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.STM_NOINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_CMPINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_FREE, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     + CASE ';
v_sql := v_sql||'                          WHEN T2.BALINTFLAG = ''+'' ';
v_sql := v_sql||'                          THEN ';
v_sql := v_sql||'                               COAL (T2.BAL_INT, 0) ';
v_sql := v_sql||'                             * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                          ELSE ';
v_sql := v_sql||'                             0 ';
v_sql := v_sql||'                       END ';
v_sql := v_sql||'                     +   COAL (T2.BAL_MP, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_ORINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_NOINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.Auths_Amt, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.MP_REM_PPL, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.MP_AUTHS, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       * (  T2.END_DATE ';
v_sql := v_sql||'                          - CASE ';
v_sql := v_sql||'                               WHEN todate(t.START_DATE,''yyyy-mm-dd'') < ';
v_sql := v_sql||'                                       ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                               THEN ';
v_sql := v_sql||'                                  ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                               ELSE ';
v_sql := v_sql||'                                  t.START_DATE ';
v_sql := v_sql||'                            END))) ';
v_sql := v_sql||'                    AS BAL_WO_AUTHS ';
v_sql := v_sql||'            FROM V_FDM_S24_ACCX T2 ';
v_sql := v_sql||'                 INNER JOIN FDM_S24_CUR_ACCT t ';
v_sql := v_sql||'                    ON t.XACCOUNT = T2.XACCOUNT ';
v_sql := v_sql||'                 LEFT JOIN V_PRMXR B ';
v_sql := v_sql||'                    ON T2.BANK = B.BANK AND T2.CURR_NUM = B.CURR_NUM ';
v_sql := v_sql||' LEFT JOIN (select C.code_value,C.bank_id from ccam_codes C, tbl_banks B  where B.bankid = C.bank_id and  C.code_type = ''TSZH'') tc ';
v_sql := v_sql||'                    ON T2.CATEGORY = tc.code_value ';
v_sql := v_sql||'           WHERE     todate(T2.END_DATE,''yyyy-mm-dd'') >= ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                 AND todate(T2.END_DATE,''yyyy-mm-dd'') < date_add(toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), 1) ';
v_sql := v_sql||'                 AND tc.bank_id is null ';
v_sql := v_sql||'         GROUP BY T.CUSTR_NBR) acca on ACCT.CUSTR_NBR = acca.CUSTR_NBR ';

    DBMS_OUTPUT.PUT_LINE('prc_generate_limitusage_data2 after:==========' || v_sql);
  
    execute immediate v_sql;

    SET result = '1';
  
    DBMS_OUTPUT.PUT_LINE('prc_generate_limitusage_data2 over:==========success!');

--EXCEPTION WHEN OTHERS THEN
 -- DBMS_OUTPUT.PUT_LINE('prc_generate_limitusage_data2 Error');
END;

CREATE OR REPLACE PROCEDURE prc_generate_limitusage_data_3 (IN YWDATE STRING, OUT result STRING)
BEGIN

DECLARE
  v_sql      varchar(100000);
  
  --SET YWDATE = '2016-05-17';
  DBMS_OUTPUT.PUT_LINE ('YWDATE ===' || YWDATE);
  SET result = '0';

  DBMS_OUTPUT.PUT_LINE ('prc_generate_limitusage_data_3 START');
     
   DBMS_OUTPUT.PUT_LINE('prc_generate_limitusage_data_3 before:=========' || v_sql);
v_sql := ' INSERT INTO TEMP_CUSTNUM_LimitUsage_3 ';
v_sql := v_sql||' SELECT acct.CUSTR_NBR, ';
v_sql := v_sql||'       acct.LIMIT, ';
v_sql := v_sql||'       acct.limit_add14, ';
v_sql := v_sql||'       (acct.bal + COAL (ACCA.BAL, 0)) AS bal, ';
v_sql := v_sql||'       (acct.bal_add14 + COAL (ACCA.BAL_add14, 0)) AS bal_add14, ';
v_sql := v_sql||'       (acct.BAL_WO_AUTHS + COAL (ACCA.BAL_WO_AUTHS, 0)) AS BAL_WO_AUTHS, ';
v_sql := v_sql||'       date_diff(toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), ';
v_sql := v_sql||'       ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''),-1)) ';
v_sql := v_sql||'  FROM (  SELECT final.CUSTR_NBR AS CUSTR_NBR, ';
v_sql := v_sql||'                 MAX (final.LIMIT + 0) AS LIMIT, ';
v_sql := v_sql||'                 MAX (final.limit_add14 + 0) AS limit_add14, ';
v_sql := v_sql||'                 SUM (final.bal) AS bal, ';
v_sql := v_sql||'                 SUM (final.bal_add14) AS bal_add14, ';
v_sql := v_sql||'                 SUM (final.BAL_WO_AUTHS) AS BAL_WO_AUTHS ';
v_sql := v_sql||'            FROM (  SELECT SRC.XACCOUNT AS XACCOUNT, ';
v_sql := v_sql||'                           SRC.CUSTR_NBR AS CUSTR_NBR, ';
v_sql := v_sql||'                           ROUND ( ';
v_sql := v_sql||'                              SUM ( ';
v_sql := v_sql||'                                 CASE ';
v_sql := v_sql||'                                    WHEN src.tempDays = 0 ';
v_sql := v_sql||'                                    THEN ';
v_sql := v_sql||'                                       src.days * CRED_LIMIT ';
v_sql := v_sql||'                                    ELSE ';
v_sql := v_sql||'                                           (src.days - src.tempDays) ';
v_sql := v_sql||'                                         * src.CRED_LIMIT ';
v_sql := v_sql||'                                       + src.tempDays * src.TEMP_LIMIT ';
v_sql := v_sql||'                                 END), ';
v_sql := v_sql||'                              4) ';
v_sql := v_sql||'                              LIMIT, ';
v_sql := v_sql||'                             ROUND ( ';
v_sql := v_sql||'                                SUM ( ';
v_sql := v_sql||'                                   CASE ';
v_sql := v_sql||'                                      WHEN src.tempDays = 0 ';
v_sql := v_sql||'                                      THEN ';
v_sql := v_sql||'                                         src.days * CRED_LIMIT ';
v_sql := v_sql||'                                      ELSE ';
v_sql := v_sql||'                                             (src.days - src.tempDays) ';
v_sql := v_sql||'                                           * src.CRED_LIMIT ';
v_sql := v_sql||'                                         + src.tempDays * src.TEMP_LIMIT ';
v_sql := v_sql||'                                   END), ';
v_sql := v_sql||'                                4) ';
v_sql := v_sql||'                           + ROUND (SUM (src.MP_L_LMT * days), 4) ';
v_sql := v_sql||'                              LIMIT_ADD14, ';
v_sql := v_sql||'                           ROUND (SUM (BAL * days), 4) BAL, ';
v_sql := v_sql||'                           ROUND (SUM (BAL_ADD14 * days), 4) BAL_ADD14, ';
v_sql := v_sql||'                           ROUND (SUM (BAL_WO_AUTHS * days), 4) BAL_WO_AUTHS ';
v_sql := v_sql||'                      FROM (SELECT S.XACCOUNT XACCOUNT, ';
v_sql := v_sql||'                                   S.CUSTR_NBR CUSTR_NBR, ';
v_sql := v_sql||'                                   floor (CASE ';
v_sql := v_sql||'                                   WHEN S.TLMT_END = ''0'' THEN 0 ';
v_sql := v_sql||'                                   WHEN (S.TLMT_END + 0) <= S.TLMT_BEG THEN 0 ';
v_sql := v_sql||'                                      WHEN     (S.TLMT_BEG + 0) <= ';
v_sql := v_sql||'                                                     toDate(S.END_DATE, ';
v_sql := v_sql||'                                                              ''yyyymmdd'') ';
v_sql := v_sql||'                                           AND (S.TLMT_END + 0) > ';
v_sql := v_sql||'                                                     toDate(S.END_DATE, ';
v_sql := v_sql||'                                                              ''yyyymmdd'') ';
v_sql := v_sql||'                                      THEN ';
v_sql := v_sql||'                                           date_diff(todate(S.END_DATE,''yyyy-mm-dd'') ';
v_sql := v_sql||'                                         , CASE ';
v_sql := v_sql||'                                              WHEN (S.START_DATE + 0) <= ';
v_sql := v_sql||'                                                      toDate(S.TLMT_BEG, ';
v_sql := v_sql||'                                                               ''yyyymmdd'') ';
v_sql := v_sql||'                                              THEN ';
v_sql := v_sql||'                                                 toDate(S.TLMT_BEG, ';
v_sql := v_sql||'                                                          ''yyyymmdd'') ';
v_sql := v_sql||'                                              ELSE ';
v_sql := v_sql||'                                                 CASE ';
v_sql := v_sql||'                                                    WHEN todate(S.START_DATE,''yyyy-mm-dd'') > ';
v_sql := v_sql||'                                                            ADD_MONTHS ( ';
v_sql := v_sql||'                                                               toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), ';
v_sql := v_sql||'                                                               -1) ';
v_sql := v_sql||'                                                    THEN ';
v_sql := v_sql||'                                                       S.START_DATE ';
v_sql := v_sql||'                                                    ELSE ';
v_sql := v_sql||'                                                       ADD_MONTHS ( ';
v_sql := v_sql||'                                                          toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), ';
v_sql := v_sql||'                                                          -1) ';
v_sql := v_sql||'                                                 END ';
v_sql := v_sql||'                                           END) ';
v_sql := v_sql||'                                       WHEN     (S.TLMT_BEG + 0) <= ';
v_sql := v_sql||'                                                             toDate(S.END_DATE, ';
v_sql := v_sql||'                                                                      ''yyyymmdd'') ';
v_sql := v_sql||'                                                   AND (S.TLMT_END + 0) <= ';
v_sql := v_sql||'                                                             toDate(S.END_DATE, ';
v_sql := v_sql||'                                                                      ''yyyymmdd'') ';
v_sql := v_sql||'                                              THEN ';
v_sql := v_sql||'                                                         date_diff(toDate(S.TLMT_END, ';
v_sql := v_sql||'                                                                  ''yyyymmdd'') ';
v_sql := v_sql||'                                                 , ';
v_sql := v_sql||'                                                         CASE ';
v_sql := v_sql||'                                                                 WHEN (S.START_DATE + 0) <= ';
v_sql := v_sql||'                                                                         toDate(S.TLMT_BEG, ';
v_sql := v_sql||'                                                                                  ''yyyymmdd'') ';
v_sql := v_sql||'                                                                 THEN ';
v_sql := v_sql||'                                                                    toDate(S.TLMT_BEG, ';
v_sql := v_sql||'                                                                             ''yyyymmdd'') ';
v_sql := v_sql||'                                                                 ELSE ';
v_sql := v_sql||'                                                                    CASE ';
v_sql := v_sql||'                                                                       WHEN todate(S.START_DATE,''yyyy-mm-dd'') > ';
v_sql := v_sql||'                                                                               ADD_MONTHS ( ';
v_sql := v_sql||'                                                                                  toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), ';
v_sql := v_sql||'                                                                                  -1) ';
v_sql := v_sql||'                                                                       THEN ';
v_sql := v_sql||'                                                                          S.START_DATE ';
v_sql := v_sql||'                                                                       ELSE ';
v_sql := v_sql||'                                                                          ADD_MONTHS ( ';
v_sql := v_sql||'                                                                             toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), ';
v_sql := v_sql||'                                                                             -1) ';
v_sql := v_sql||'                                                                    END ';
v_sql := v_sql||'                                                          END) ';
v_sql := v_sql||'                                          ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                   END ';
v_sql := v_sql||'                                    )  tempDays, ';
v_sql := v_sql||'                                   S.TEMP_LIMIT TEMP_LIMIT, ';
v_sql := v_sql||'                                   S.CRED_LIMIT CRED_LIMIT, ';
v_sql := v_sql||'                                   A.MP_L_LMT MP_L_LMT, ';
v_sql := v_sql||'                                  date_diff (   S.END_DATE ';
v_sql := v_sql||'                                   , CASE ';
v_sql := v_sql||'                                        WHEN todate(S.START_DATE,''yyyy-mm-dd'') < ';
v_sql := v_sql||'                                                ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), ';
v_sql := v_sql||'                                                            -1) ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           todate(S.START_DATE,''yyyy-mm-dd'') ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                      ) days, ';
v_sql := v_sql||'                                     COAL (S.STM_BALFRE, 0) ';
v_sql := v_sql||'                                   + ';
v_sql := v_sql||'                                    CASE ';
v_sql := v_sql||'                                        WHEN S.STMBALINTFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.STM_BALINT ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + COAL (S.STM_BALMP, 0) ';
v_sql := v_sql||'                                   + COAL (S.STM_BALORI, 0) ';
v_sql := v_sql||'                                   + COAL (S.STM_NOINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_CMPINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_FREE, 0) ';
v_sql := v_sql||'                                   + CASE ';
v_sql := v_sql||'                                        WHEN S.BAL_INTFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.BAL_INT ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + CASE ';
v_sql := v_sql||'                                        WHEN S.BAL_MPFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.BAL_MP ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + COAL (S.BAL_ORINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_NOINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.Auths_Amt, 0) ';
v_sql := v_sql||'                                   + COAL (S.MP_REM_PPL, 0) ';
v_sql := v_sql||'                                   + COAL (A.MP_BAL, 0) ';
v_sql := v_sql||'                                   + COAL (S.MP_AUTHS, 0) ';
v_sql := v_sql||'                                   + COAL (A.MP_AUTHS, 0) ';
v_sql := v_sql||'                                      AS BAL_ADD14, ';
v_sql := v_sql||'                                     COAL (S.STM_BALFRE, 0) ';
v_sql := v_sql||'                                   + ';
v_sql := v_sql||'                                    CASE ';
v_sql := v_sql||'                                        WHEN S.STMBALINTFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.STM_BALINT ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + COAL (S.STM_BALMP, 0) ';
v_sql := v_sql||'                                   + COAL (S.STM_BALORI, 0) ';
v_sql := v_sql||'                                   + COAL (S.STM_NOINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_CMPINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_FREE, 0) ';
v_sql := v_sql||'                                   + CASE ';
v_sql := v_sql||'                                        WHEN S.BAL_INTFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.BAL_INT ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + CASE ';
v_sql := v_sql||'                                        WHEN S.BAL_MPFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.BAL_MP ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + COAL (S.BAL_ORINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_NOINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.Auths_Amt, 0) ';
v_sql := v_sql||'                                   + COAL (S.MP_REM_PPL, 0) ';
v_sql := v_sql||'                                   + COAL (S.MP_AUTHS, 0) ';
v_sql := v_sql||'                                      AS BAL , ';
v_sql := v_sql||'                                    COAL (S.STM_BALFRE, 0) ';
v_sql := v_sql||'                                   + ';
v_sql := v_sql||'                                    CASE ';
v_sql := v_sql||'                                        WHEN S.STMBALINTFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.STM_BALINT ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + COAL (S.STM_BALMP, 0) ';
v_sql := v_sql||'                                   + COAL (S.STM_BALORI, 0) ';
v_sql := v_sql||'                                   + COAL (S.STM_NOINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_CMPINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_FREE, 0) ';
v_sql := v_sql||'                                   + CASE ';
v_sql := v_sql||'                                        WHEN S.BAL_INTFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.BAL_INT ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + CASE ';
v_sql := v_sql||'                                        WHEN S.BAL_MPFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.BAL_MP ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + COAL (S.BAL_ORINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_NOINT, 0) ';
v_sql := v_sql||'                                      AS BAL_WO_AUTHS ';
v_sql := v_sql||'                              FROM (select t.* from V_FDM_S24_ACCT t left join ';
v_sql := v_sql||' (select C.code_value,C.bank_id from ccam_codes C, tbl_banks B  where B.bankid = C.bank_id and  C.code_type = ''TSZH'') ta ';
v_sql := v_sql||'                              on t.CATEGORY = ta.code_value where ta.bank_id is null ) s ';
v_sql := v_sql||'                                   LEFT JOIN V_FDM_S24_ACCA a ';
v_sql := v_sql||'                                      ON     S.START_DATE = A.START_DATE ';
v_sql := v_sql||'                                         AND S.XACCOUNT = A.XACCOUNT ';
v_sql := v_sql||'                                         AND todate(A.END_DATE,''yyyy-mm-dd'') >= ';
v_sql := v_sql||'                                                ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), ';
v_sql := v_sql||'                                                            -1) ';
v_sql := v_sql||'                                         AND todate(A.END_DATE,''yyyy-mm-dd'') < date_add(toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), 1) ';
v_sql := v_sql||' LEFT JOIN (select C.code_value,C.bank_id from ccam_codes C, tbl_banks B  where B.bankid = C.bank_id and  C.code_type = ''TSCP'') tb ';
v_sql := v_sql||'                                      ON     S.PROD_NBR = tb.code_value ';
v_sql := v_sql||'                             WHERE     todate(S.END_DATE,''yyyy-mm-dd'') >= ';
v_sql := v_sql||'                                          ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                                   AND todate(S.END_DATE,''yyyy-mm-dd'') < date_add(toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), 1) ';
v_sql := v_sql||'                                   AND tb.bank_id is null ';
v_sql := v_sql||'                                                          ) src ';
v_sql := v_sql||'                  GROUP BY SRC.XACCOUNT, SRC.CUSTR_NBR) final ';
v_sql := v_sql||'        GROUP BY final.CUSTR_NBR) acct left join ';
v_sql := v_sql||'       (  SELECT T.CUSTR_NBR, ';
v_sql := v_sql||'                 SUM ( ';
v_sql := v_sql||'                      (    COAL (T2.STM_BALFRE, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       + ';
v_sql := v_sql||'                        CASE ';
v_sql := v_sql||'                            WHEN T2.STMBALINTFLAG = ''+'' ';
v_sql := v_sql||'                            THEN ';
v_sql := v_sql||'                                 COAL (T2.STM_BALINT, 0) ';
v_sql := v_sql||'                               * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                            ELSE ';
v_sql := v_sql||'                               0 ';
v_sql := v_sql||'                         END ';
v_sql := v_sql||'                       +   COAL (T2.STM_BALMP, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.STM_BALORI, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.STM_NOINT, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.BAL_CMPINT, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.BAL_FREE, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       + CASE ';
v_sql := v_sql||'                            WHEN T2.BALINTFLAG = ''+'' ';
v_sql := v_sql||'                            THEN ';
v_sql := v_sql||'                                 COAL (T2.BAL_INT, 0) ';
v_sql := v_sql||'                               * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                            ELSE ';
v_sql := v_sql||'                               0 ';
v_sql := v_sql||'                         END ';
v_sql := v_sql||'                       +   COAL (T2.BAL_MP, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.BAL_ORINT, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.BAL_NOINT, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.Auths_Amt, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.MP_REM_PPL, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.MP_AUTHS, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                                                    ) ';
v_sql := v_sql||'                    * (  T2.END_DATE ';
v_sql := v_sql||'                       - CASE ';
v_sql := v_sql||'                            WHEN todate(t.START_DATE,''yyyy-mm-dd'') < ';
v_sql := v_sql||'                                    ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                            THEN ';
v_sql := v_sql||'                               ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                            ELSE ';
v_sql := v_sql||'                               t.START_DATE ';
v_sql := v_sql||'                         END)) ';
v_sql := v_sql||'                    AS BAL_ADD14, ';
v_sql := v_sql||'                 SUM ( ';
v_sql := v_sql||'                    (    COAL (T2.STM_BALFRE, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     + ';
v_sql := v_sql||'                      CASE ';
v_sql := v_sql||'                          WHEN T2.STMBALINTFLAG = ''+'' ';
v_sql := v_sql||'                          THEN ';
v_sql := v_sql||'                               COAL (T2.STM_BALINT, 0) ';
v_sql := v_sql||'                             * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                          ELSE ';
v_sql := v_sql||'                             0 ';
v_sql := v_sql||'                       END ';
v_sql := v_sql||'                     +   COAL (T2.STM_BALMP, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.STM_BALORI, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.STM_NOINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_CMPINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_FREE, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     + CASE ';
v_sql := v_sql||'                          WHEN T2.BALINTFLAG = ''+'' ';
v_sql := v_sql||'                          THEN ';
v_sql := v_sql||'                               COAL (T2.BAL_INT, 0) ';
v_sql := v_sql||'                             * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                          ELSE ';
v_sql := v_sql||'                             0 ';
v_sql := v_sql||'                       END ';
v_sql := v_sql||'                     +   COAL (T2.BAL_MP, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_ORINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_NOINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.Auths_Amt, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.MP_REM_PPL, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.MP_AUTHS, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       * (  T2.END_DATE ';
v_sql := v_sql||'                          - CASE ';
v_sql := v_sql||'                               WHEN todate(t.START_DATE,''yyyy-mm-dd'') < ';
v_sql := v_sql||'                                       ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                               THEN ';
v_sql := v_sql||'                                  ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                               ELSE ';
v_sql := v_sql||'                                  t.START_DATE ';
v_sql := v_sql||'                            END))) ';
v_sql := v_sql||'                    AS BAL , ';
v_sql := v_sql||'                                            SUM ( ';
v_sql := v_sql||'                    (    COAL (T2.STM_BALFRE, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     + ';
v_sql := v_sql||'                      CASE ';
v_sql := v_sql||'                          WHEN T2.STMBALINTFLAG = ''+'' ';
v_sql := v_sql||'                          THEN ';
v_sql := v_sql||'                               COAL (T2.STM_BALINT, 0) ';
v_sql := v_sql||'                             * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                          ELSE ';
v_sql := v_sql||'                             0 ';
v_sql := v_sql||'                       END ';
v_sql := v_sql||'                     +   COAL (T2.STM_BALMP, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.STM_BALORI, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.STM_NOINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_CMPINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_FREE, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     + CASE ';
v_sql := v_sql||'                          WHEN T2.BALINTFLAG = ''+'' ';
v_sql := v_sql||'                          THEN ';
v_sql := v_sql||'                               COAL (T2.BAL_INT, 0) ';
v_sql := v_sql||'                             * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                          ELSE ';
v_sql := v_sql||'                             0 ';
v_sql := v_sql||'                       END ';
v_sql := v_sql||'                     +   COAL (T2.BAL_MP, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_ORINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_NOINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.Auths_Amt, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.MP_REM_PPL, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.MP_AUTHS, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       * (  T2.END_DATE ';
v_sql := v_sql||'                          - CASE ';
v_sql := v_sql||'                               WHEN todate(t.START_DATE,''yyyy-mm-dd'') < ';
v_sql := v_sql||'                                       ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                               THEN ';
v_sql := v_sql||'                                  ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                               ELSE ';
v_sql := v_sql||'                                  t.START_DATE ';
v_sql := v_sql||'                            END))) ';
v_sql := v_sql||'                    AS BAL_WO_AUTHS ';
v_sql := v_sql||'            FROM V_FDM_S24_ACCX T2 ';
v_sql := v_sql||'                 INNER JOIN FDM_S24_CUR_ACCT t ';
v_sql := v_sql||'                    ON t.XACCOUNT = T2.XACCOUNT ';
v_sql := v_sql||'                 LEFT JOIN V_PRMXR B ';
v_sql := v_sql||'                    ON T2.BANK = B.BANK AND T2.CURR_NUM = B.CURR_NUM ';
v_sql := v_sql||' LEFT JOIN (select C.code_value,C.bank_id from ccam_codes C, tbl_banks B  where B.bankid = C.bank_id and  C.code_type = ''TSZH'') tc ';
v_sql := v_sql||'                    ON T2.CATEGORY = tc.code_value ';
v_sql := v_sql||'           WHERE     todate(T2.END_DATE,''yyyy-mm-dd'') >= ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                 AND todate(T2.END_DATE,''yyyy-mm-dd'') < date_add(toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), 1) ';
v_sql := v_sql||'                 AND tc.bank_id is null ';
v_sql := v_sql||'        GROUP BY T.CUSTR_NBR) acca on ACCT.CUSTR_NBR = acca.CUSTR_NBR ';

    DBMS_OUTPUT.PUT_LINE('prc_generate_limitusage_data3 after:==========' || v_sql);
  
    execute immediate v_sql;

    SET result = '1';
  
    DBMS_OUTPUT.PUT_LINE('prc_generate_limitusage_data3 over:==========success!');

--EXCEPTION WHEN OTHERS THEN
 -- DBMS_OUTPUT.PUT_LINE('prc_generate_limitusage_data3 Error');
END;

CREATE OR REPLACE PROCEDURE prc_generate_limitusage_data_4 (IN YWDATE STRING, OUT result STRING)
BEGIN

DECLARE
  v_sql      varchar(100000);
  
  --SET YWDATE = '2016-05-17';
  DBMS_OUTPUT.PUT_LINE ('YWDATE ===' || YWDATE);
  SET result = '0';

  DBMS_OUTPUT.PUT_LINE ('prc_generate_limitusage_data_4 START');
     
   DBMS_OUTPUT.PUT_LINE('prc_generate_limitusage_data_4 before:=========' || v_sql);
v_sql := ' INSERT INTO TEMP_CUSTNUM_LimitUsage_4 ';
v_sql := v_sql||' SELECT acct.CUSTR_NBR, ';
v_sql := v_sql||'       acct.LIMIT, ';
v_sql := v_sql||'       acct.limit_add14, ';
v_sql := v_sql||'       (acct.bal + COAL (ACCA.BAL, 0)) AS bal, ';
v_sql := v_sql||'       (acct.bal_add14 + COAL (ACCA.BAL_add14, 0)) AS bal_add14, ';
v_sql := v_sql||'       (acct.BAL_WO_AUTHS + COAL (ACCA.BAL_WO_AUTHS, 0)) AS BAL_WO_AUTHS, ';
v_sql := v_sql||'       date_diff(toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), ';
v_sql := v_sql||'       ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''),-1)) ';
v_sql := v_sql||'  FROM (  SELECT final.CUSTR_NBR AS CUSTR_NBR, ';
v_sql := v_sql||'                 MAX (final.LIMIT + 0) AS LIMIT, ';
v_sql := v_sql||'                 MAX (final.limit_add14 + 0) AS limit_add14, ';
v_sql := v_sql||'                 SUM (final.bal) AS bal, ';
v_sql := v_sql||'                 SUM (final.bal_add14) AS bal_add14, ';
v_sql := v_sql||'                 SUM (final.BAL_WO_AUTHS) AS BAL_WO_AUTHS ';
v_sql := v_sql||'            FROM (  SELECT SRC.XACCOUNT AS XACCOUNT, ';
v_sql := v_sql||'                           SRC.CUSTR_NBR AS CUSTR_NBR, ';
v_sql := v_sql||'                           ROUND ( ';
v_sql := v_sql||'                              SUM ( ';
v_sql := v_sql||'                                 CASE ';
v_sql := v_sql||'                                    WHEN src.tempDays = 0 ';
v_sql := v_sql||'                                    THEN ';
v_sql := v_sql||'                                       src.days * CRED_LIMIT ';
v_sql := v_sql||'                                    ELSE ';
v_sql := v_sql||'                                           (src.days - src.tempDays) ';
v_sql := v_sql||'                                         * src.CRED_LIMIT ';
v_sql := v_sql||'                                       + src.tempDays * src.TEMP_LIMIT ';
v_sql := v_sql||'                                 END), ';
v_sql := v_sql||'                              4) ';
v_sql := v_sql||'                              LIMIT, ';
v_sql := v_sql||'                             ROUND ( ';
v_sql := v_sql||'                                SUM ( ';
v_sql := v_sql||'                                   CASE ';
v_sql := v_sql||'                                      WHEN src.tempDays = 0 ';
v_sql := v_sql||'                                      THEN ';
v_sql := v_sql||'                                         src.days * CRED_LIMIT ';
v_sql := v_sql||'                                      ELSE ';
v_sql := v_sql||'                                             (src.days - src.tempDays) ';
v_sql := v_sql||'                                           * src.CRED_LIMIT ';
v_sql := v_sql||'                                         + src.tempDays * src.TEMP_LIMIT ';
v_sql := v_sql||'                                   END), ';
v_sql := v_sql||'                                4) ';
v_sql := v_sql||'                           + ROUND (SUM (src.MP_L_LMT * days), 4) ';
v_sql := v_sql||'                              LIMIT_ADD14, ';
v_sql := v_sql||'                           ROUND (SUM (BAL * days), 4) BAL, ';
v_sql := v_sql||'                           ROUND (SUM (BAL_ADD14 * days), 4) BAL_ADD14, ';
v_sql := v_sql||'                           ROUND (SUM (BAL_WO_AUTHS * days), 4) BAL_WO_AUTHS ';
v_sql := v_sql||'                      FROM (SELECT S.XACCOUNT XACCOUNT, ';
v_sql := v_sql||'                                   S.CUSTR_NBR CUSTR_NBR, ';
v_sql := v_sql||'                                   floor (CASE ';
v_sql := v_sql||'                                   WHEN S.TLMT_END = ''0'' THEN 0 ';
v_sql := v_sql||'                                   WHEN (S.TLMT_END + 0) <= S.TLMT_BEG THEN 0 ';
v_sql := v_sql||'                                      WHEN     (S.TLMT_BEG + 0) <= ';
v_sql := v_sql||'                                                     toDate(S.END_DATE, ';
v_sql := v_sql||'                                                              ''yyyymmdd'') ';
v_sql := v_sql||'                                           AND (S.TLMT_END + 0) > ';
v_sql := v_sql||'                                                     toDate(S.END_DATE, ';
v_sql := v_sql||'                                                              ''yyyymmdd'') ';
v_sql := v_sql||'                                      THEN ';
v_sql := v_sql||'                                           S.END_DATE ';
v_sql := v_sql||'                                         - CASE ';
v_sql := v_sql||'                                              WHEN (S.START_DATE + 0) <= ';
v_sql := v_sql||'                                                      toDate(S.TLMT_BEG, ';
v_sql := v_sql||'                                                               ''yyyymmdd'') ';
v_sql := v_sql||'                                              THEN ';
v_sql := v_sql||'                                                 toDate(S.TLMT_BEG, ';
v_sql := v_sql||'                                                          ''yyyymmdd'') ';
v_sql := v_sql||'                                              ELSE ';
v_sql := v_sql||'                                                 CASE ';
v_sql := v_sql||'                                                    WHEN todate(S.START_DATE,''yyyy-mm-dd'') > ';
v_sql := v_sql||'                                                            ADD_MONTHS ( ';
v_sql := v_sql||'                                                               toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), ';
v_sql := v_sql||'                                                               -1) ';
v_sql := v_sql||'                                                    THEN ';
v_sql := v_sql||'                                                       S.START_DATE ';
v_sql := v_sql||'                                                    ELSE ';
v_sql := v_sql||'                                                       ADD_MONTHS ( ';
v_sql := v_sql||'                                                          toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), ';
v_sql := v_sql||'                                                          -1) ';
v_sql := v_sql||'                                                 END ';
v_sql := v_sql||'                                           END ';
v_sql := v_sql||'                                       WHEN     (S.TLMT_BEG + 0) <= ';
v_sql := v_sql||'                                                             toDate(S.END_DATE, ';
v_sql := v_sql||'                                                                      ''yyyymmdd'') ';
v_sql := v_sql||'                                                   AND (S.TLMT_END + 0) <= ';
v_sql := v_sql||'                                                             toDate(S.END_DATE, ';
v_sql := v_sql||'                                                                      ''yyyymmdd'') ';
v_sql := v_sql||'                                              THEN ';
v_sql := v_sql||'                                                         toDate(S.TLMT_END, ';
v_sql := v_sql||'                                                                  ''yyyymmdd'') ';
v_sql := v_sql||'                                                 - ';
v_sql := v_sql||'                                                         CASE ';
v_sql := v_sql||'                                                                 WHEN (S.START_DATE + 0) <= ';
v_sql := v_sql||'                                                                         toDate(S.TLMT_BEG, ';
v_sql := v_sql||'                                                                                  ''yyyymmdd'') ';
v_sql := v_sql||'                                                                 THEN ';
v_sql := v_sql||'                                                                    toDate(S.TLMT_BEG, ';
v_sql := v_sql||'                                                                             ''yyyymmdd'') ';
v_sql := v_sql||'                                                                 ELSE ';
v_sql := v_sql||'                                                                    CASE ';
v_sql := v_sql||'                                                                       WHEN todate(S.START_DATE,''yyyy-mm-dd'') > ';
v_sql := v_sql||'                                                                               ADD_MONTHS ( ';
v_sql := v_sql||'                                                                                  toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), ';
v_sql := v_sql||'                                                                                  -1) ';
v_sql := v_sql||'                                                                       THEN ';
v_sql := v_sql||'                                                                          S.START_DATE ';
v_sql := v_sql||'                                                                       ELSE ';
v_sql := v_sql||'                                                                          ADD_MONTHS ( ';
v_sql := v_sql||'                                                                             toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), ';
v_sql := v_sql||'                                                                             -1) ';
v_sql := v_sql||'                                                                    END ';
v_sql := v_sql||'                                                          END ';
v_sql := v_sql||'                                          ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                   END ';
v_sql := v_sql||'                                    )  tempDays, ';
v_sql := v_sql||'                                   S.TEMP_LIMIT TEMP_LIMIT, ';
v_sql := v_sql||'                                   S.CRED_LIMIT CRED_LIMIT, ';
v_sql := v_sql||'                                   A.MP_L_LMT MP_L_LMT, ';
v_sql := v_sql||'                                  date_diff (   S.END_DATE ';
v_sql := v_sql||'                                   , CASE ';
v_sql := v_sql||'                                        WHEN todate(S.START_DATE,''yyyy-mm-dd'') < ';
v_sql := v_sql||'                                                ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), ';
v_sql := v_sql||'                                                            -1) ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           todate(S.START_DATE,''yyyy-mm-dd'') ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                      ) days, ';
v_sql := v_sql||'                                     COAL (S.STM_BALFRE, 0) ';
v_sql := v_sql||'                                   + ';
v_sql := v_sql||'                                    CASE ';
v_sql := v_sql||'                                        WHEN S.STMBALINTFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.STM_BALINT ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + COAL (S.STM_BALMP, 0) ';
v_sql := v_sql||'                                   + COAL (S.STM_BALORI, 0) ';
v_sql := v_sql||'                                   + COAL (S.STM_NOINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_CMPINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_FREE, 0) ';
v_sql := v_sql||'                                   + CASE ';
v_sql := v_sql||'                                        WHEN S.BAL_INTFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.BAL_INT ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + CASE ';
v_sql := v_sql||'                                        WHEN S.BAL_MPFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.BAL_MP ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + COAL (S.BAL_ORINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_NOINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.Auths_Amt, 0) ';
v_sql := v_sql||'                                   + COAL (S.MP_REM_PPL, 0) ';
v_sql := v_sql||'                                   + COAL (A.MP_BAL, 0) ';
v_sql := v_sql||'                                   + COAL (S.MP_AUTHS, 0) ';
v_sql := v_sql||'                                   + COAL (A.MP_AUTHS, 0) ';
v_sql := v_sql||'                                      AS BAL_ADD14, ';
v_sql := v_sql||'                                     COAL (S.STM_BALFRE, 0) ';
v_sql := v_sql||'                                   + ';
v_sql := v_sql||'                                    CASE ';
v_sql := v_sql||'                                        WHEN S.STMBALINTFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.STM_BALINT ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + COAL (S.STM_BALMP, 0) ';
v_sql := v_sql||'                                   + COAL (S.STM_BALORI, 0) ';
v_sql := v_sql||'                                   + COAL (S.STM_NOINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_CMPINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_FREE, 0) ';
v_sql := v_sql||'                                   + CASE ';
v_sql := v_sql||'                                        WHEN S.BAL_INTFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.BAL_INT ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + CASE ';
v_sql := v_sql||'                                        WHEN S.BAL_MPFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.BAL_MP ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + COAL (S.BAL_ORINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_NOINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.Auths_Amt, 0) ';
v_sql := v_sql||'                                   + COAL (S.MP_REM_PPL, 0) ';
v_sql := v_sql||'                                   + COAL (S.MP_AUTHS, 0) ';
v_sql := v_sql||'                                      AS BAL , ';
v_sql := v_sql||'                                    COAL (S.STM_BALFRE, 0) ';
v_sql := v_sql||'                                   + ';
v_sql := v_sql||'                                    CASE ';
v_sql := v_sql||'                                        WHEN S.STMBALINTFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.STM_BALINT ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + COAL (S.STM_BALMP, 0) ';
v_sql := v_sql||'                                   + COAL (S.STM_BALORI, 0) ';
v_sql := v_sql||'                                   + COAL (S.STM_NOINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_CMPINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_FREE, 0) ';
v_sql := v_sql||'                                   + CASE ';
v_sql := v_sql||'                                        WHEN S.BAL_INTFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.BAL_INT ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + CASE ';
v_sql := v_sql||'                                        WHEN S.BAL_MPFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.BAL_MP ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END  ';
v_sql := v_sql||'                                   + COAL (S.BAL_ORINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_NOINT, 0) ';
v_sql := v_sql||'                                      AS BAL_WO_AUTHS ';
v_sql := v_sql||'                              FROM (select t.* from V_FDM_S24_ACCT t left join  ';
v_sql := v_sql||' (select C.code_value,C.bank_id from ccam_codes C, tbl_banks B  where B.bankid = C.bank_id and  C.code_type = ''TSZH'') ta ';
v_sql := v_sql||'                              on t.CATEGORY = ta.code_value where ta.bank_id is null ) s ';
v_sql := v_sql||'                                   LEFT JOIN V_FDM_S24_ACCA a ';
v_sql := v_sql||'                                      ON     S.START_DATE = A.START_DATE ';
v_sql := v_sql||'                                         AND S.XACCOUNT = A.XACCOUNT ';
v_sql := v_sql||'                                         AND todate(A.END_DATE,''yyyy-mm-dd'') >= ';
v_sql := v_sql||'                                                ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), ';
v_sql := v_sql||'                                                            -1) ';
v_sql := v_sql||'                                         AND todate(A.END_DATE,''yyyy-mm-dd'') < date_add(toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), 1) ';
v_sql := v_sql||' LEFT JOIN (select C.code_value,C.bank_id from ccam_codes C, tbl_banks B  where B.bankid = C.bank_id and  C.code_type = ''TSCP'') tb ';
v_sql := v_sql||'                                      ON     S.PROD_NBR = tb.code_value ';
v_sql := v_sql||'                             WHERE     todate(S.END_DATE,''yyyy-mm-dd'') >= ';
v_sql := v_sql||'                                          ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                                   AND todate(S.END_DATE,''yyyy-mm-dd'') < date_add(toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), 1) ';
v_sql := v_sql||'                                   AND tb.bank_id is null ';
v_sql := v_sql||'                                                          ) src ';
v_sql := v_sql||'                  GROUP BY SRC.XACCOUNT, SRC.CUSTR_NBR) final ';
v_sql := v_sql||'        GROUP BY final.CUSTR_NBR) acct left join ';
v_sql := v_sql||'       (  SELECT T.CUSTR_NBR, ';
v_sql := v_sql||'                 SUM ( ';
v_sql := v_sql||'                      (    COAL (T2.STM_BALFRE, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       + ';
v_sql := v_sql||'                        CASE ';
v_sql := v_sql||'                            WHEN T2.STMBALINTFLAG = ''+'' ';
v_sql := v_sql||'                            THEN ';
v_sql := v_sql||'                                 COAL (T2.STM_BALINT, 0) ';
v_sql := v_sql||'                               * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                            ELSE ';
v_sql := v_sql||'                               0 ';
v_sql := v_sql||'                         END ';
v_sql := v_sql||'                       +   COAL (T2.STM_BALMP, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.STM_BALORI, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.STM_NOINT, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.BAL_CMPINT, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.BAL_FREE, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       + CASE ';
v_sql := v_sql||'                            WHEN T2.BALINTFLAG = ''+'' ';
v_sql := v_sql||'                            THEN ';
v_sql := v_sql||'                                 COAL (T2.BAL_INT, 0) ';
v_sql := v_sql||'                               * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                            ELSE ';
v_sql := v_sql||'                               0 ';
v_sql := v_sql||'                         END ';
v_sql := v_sql||'                       +   COAL (T2.BAL_MP, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.BAL_ORINT, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.BAL_NOINT, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.Auths_Amt, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.MP_REM_PPL, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.MP_AUTHS, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                                                    ) ';
v_sql := v_sql||'                    * (  T2.END_DATE ';
v_sql := v_sql||'                       - CASE ';
v_sql := v_sql||'                            WHEN todate(t.START_DATE,''yyyy-mm-dd'') < ';
v_sql := v_sql||'                                    ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                            THEN ';
v_sql := v_sql||'                               ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                            ELSE ';
v_sql := v_sql||'                               t.START_DATE ';
v_sql := v_sql||'                         END)) ';
v_sql := v_sql||'                    AS BAL_ADD14, ';
v_sql := v_sql||'                 SUM ( ';
v_sql := v_sql||'                    (    COAL (T2.STM_BALFRE, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     + ';
v_sql := v_sql||'                      CASE ';
v_sql := v_sql||'                          WHEN T2.STMBALINTFLAG = ''+'' ';
v_sql := v_sql||'                          THEN ';
v_sql := v_sql||'                               COAL (T2.STM_BALINT, 0) ';
v_sql := v_sql||'                             * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                          ELSE ';
v_sql := v_sql||'                             0 ';
v_sql := v_sql||'                       END ';
v_sql := v_sql||'                     +   COAL (T2.STM_BALMP, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.STM_BALORI, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.STM_NOINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_CMPINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_FREE, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     + CASE ';
v_sql := v_sql||'                          WHEN T2.BALINTFLAG = ''+'' ';
v_sql := v_sql||'                          THEN ';
v_sql := v_sql||'                               COAL (T2.BAL_INT, 0) ';
v_sql := v_sql||'                             * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                          ELSE ';
v_sql := v_sql||'                             0 ';
v_sql := v_sql||'                       END ';
v_sql := v_sql||'                     +   COAL (T2.BAL_MP, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_ORINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_NOINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.Auths_Amt, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.MP_REM_PPL, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.MP_AUTHS, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       * (  T2.END_DATE ';
v_sql := v_sql||'                          - CASE ';
v_sql := v_sql||'                               WHEN todate(t.START_DATE,''yyyy-mm-dd'') < ';
v_sql := v_sql||'                                       ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                               THEN ';
v_sql := v_sql||'                                  ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                               ELSE ';
v_sql := v_sql||'                                  t.START_DATE ';
v_sql := v_sql||'                            END))) ';
v_sql := v_sql||'                    AS BAL , ';
v_sql := v_sql||'                                            SUM ( ';
v_sql := v_sql||'                    (    COAL (T2.STM_BALFRE, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     + ';
v_sql := v_sql||'                      CASE ';
v_sql := v_sql||'                          WHEN T2.STMBALINTFLAG = ''+'' ';
v_sql := v_sql||'                          THEN ';
v_sql := v_sql||'                               COAL (T2.STM_BALINT, 0) ';
v_sql := v_sql||'                             * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                          ELSE ';
v_sql := v_sql||'                             0 ';
v_sql := v_sql||'                       END ';
v_sql := v_sql||'                     +   COAL (T2.STM_BALMP, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.STM_BALORI, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.STM_NOINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_CMPINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_FREE, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     + CASE ';
v_sql := v_sql||'                          WHEN T2.BALINTFLAG = ''+'' ';
v_sql := v_sql||'                          THEN ';
v_sql := v_sql||'                               COAL (T2.BAL_INT, 0) ';
v_sql := v_sql||'                             * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                          ELSE ';
v_sql := v_sql||'                             0 ';
v_sql := v_sql||'                       END ';
v_sql := v_sql||'                     +   COAL (T2.BAL_MP, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_ORINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_NOINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.Auths_Amt, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.MP_REM_PPL, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.MP_AUTHS, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       * (  T2.END_DATE ';
v_sql := v_sql||'                          - CASE ';
v_sql := v_sql||'                               WHEN todate(t.START_DATE,''yyyy-mm-dd'') < ';
v_sql := v_sql||'                                       ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                               THEN ';
v_sql := v_sql||'                                  ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                               ELSE ';
v_sql := v_sql||'                                  t.START_DATE ';
v_sql := v_sql||'                            END))) ';
v_sql := v_sql||'                    AS BAL_WO_AUTHS ';
v_sql := v_sql||'            FROM V_FDM_S24_ACCX T2 ';
v_sql := v_sql||'                 INNER JOIN FDM_S24_CUR_ACCT t ';
v_sql := v_sql||'                    ON t.XACCOUNT = T2.XACCOUNT ';
v_sql := v_sql||'                 LEFT JOIN V_PRMXR B ';
v_sql := v_sql||'                    ON T2.BANK = B.BANK AND T2.CURR_NUM = B.CURR_NUM ';
v_sql := v_sql||' LEFT JOIN (select C.code_value,C.bank_id from ccam_codes C, tbl_banks B  where B.bankid = C.bank_id and  C.code_type = ''TSZH'') tc ';
v_sql := v_sql||'                    ON T2.CATEGORY = tc.code_value ';
v_sql := v_sql||'           WHERE     todate(T2.END_DATE,''yyyy-mm-dd'') >= ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                 AND todate(T2.END_DATE,''yyyy-mm-dd'') < date_add(toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), 1) ';
v_sql := v_sql||'                 AND tc.bank_id is null ';
v_sql := v_sql||'        GROUP BY T.CUSTR_NBR) acca on ACCT.CUSTR_NBR = acca.CUSTR_NBR ';

    DBMS_OUTPUT.PUT_LINE('prc_generate_limitusage_data4 after:==========' || v_sql);
  
    execute immediate v_sql;

    SET result = '1';
  
    DBMS_OUTPUT.PUT_LINE('prc_generate_limitusage_data4 over:==========success!');

--EXCEPTION WHEN OTHERS THEN
 -- DBMS_OUTPUT.PUT_LINE('prc_generate_limitusage_data4 Error');
END;

CREATE OR REPLACE PROCEDURE prc_generate_limitusage_data_5 (IN YWDATE STRING, OUT result STRING)
BEGIN

DECLARE
  v_sql      varchar(100000);
  
  --SET YWDATE = '2016-05-17';
  DBMS_OUTPUT.PUT_LINE ('YWDATE ===' || YWDATE);
  SET result = '0';

  DBMS_OUTPUT.PUT_LINE ('prc_generate_limitusage_data_5 START');
     
   DBMS_OUTPUT.PUT_LINE('prc_generate_limitusage_data_5 before:=========' || v_sql);
v_sql := ' INSERT INTO TEMP_CUSTNUM_LimitUsage_5 ';
v_sql := v_sql||' SELECT acct.CUSTR_NBR, ';
v_sql := v_sql||'       acct.LIMIT, ';
v_sql := v_sql||'       acct.limit_add14, ';
v_sql := v_sql||'       (acct.bal + COAL (ACCA.BAL, 0)) AS bal, ';
v_sql := v_sql||'       (acct.bal_add14 + COAL (ACCA.BAL_add14, 0)) AS bal_add14, ';
v_sql := v_sql||'       (acct.BAL_WO_AUTHS + COAL (ACCA.BAL_WO_AUTHS, 0)) AS BAL_WO_AUTHS, ';
v_sql := v_sql||'       date_diff(toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), ';
v_sql := v_sql||'       ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''),-1)) ';
v_sql := v_sql||' FROM (  SELECT final.CUSTR_NBR AS CUSTR_NBR, ';
v_sql := v_sql||'                 MAX (final.LIMIT + 0) AS LIMIT, ';
v_sql := v_sql||'                 MAX (final.limit_add14 + 0) AS limit_add14, ';
v_sql := v_sql||'                 SUM (final.bal) AS bal, ';
v_sql := v_sql||'                 SUM (final.bal_add14) AS bal_add14, ';
v_sql := v_sql||'                 SUM (final.BAL_WO_AUTHS) AS BAL_WO_AUTHS ';
v_sql := v_sql||'            FROM (  SELECT SRC.XACCOUNT AS XACCOUNT, ';
v_sql := v_sql||'                           SRC.CUSTR_NBR AS CUSTR_NBR, ';
v_sql := v_sql||'                           ROUND ( ';
v_sql := v_sql||'                              SUM ( ';
v_sql := v_sql||'                                 CASE ';
v_sql := v_sql||'                                    WHEN src.tempDays = 0 ';
v_sql := v_sql||'                                    THEN ';
v_sql := v_sql||'                                       src.days * CRED_LIMIT ';
v_sql := v_sql||'                                    ELSE ';
v_sql := v_sql||'                                           (src.days - src.tempDays) ';
v_sql := v_sql||'                                         * src.CRED_LIMIT ';
v_sql := v_sql||'                                       + src.tempDays * src.TEMP_LIMIT ';
v_sql := v_sql||'                                 END), ';
v_sql := v_sql||'                              4) ';
v_sql := v_sql||'                              LIMIT, ';
v_sql := v_sql||'                             ROUND ( ';
v_sql := v_sql||'                                SUM ( ';
v_sql := v_sql||'                                   CASE ';
v_sql := v_sql||'                                      WHEN src.tempDays = 0 ';
v_sql := v_sql||'                                      THEN ';
v_sql := v_sql||'                                         src.days * CRED_LIMIT ';
v_sql := v_sql||'                                      ELSE ';
v_sql := v_sql||'                                             (src.days - src.tempDays) ';
v_sql := v_sql||'                                           * src.CRED_LIMIT ';
v_sql := v_sql||'                                         + src.tempDays * src.TEMP_LIMIT ';
v_sql := v_sql||'                                   END), ';
v_sql := v_sql||'                                4) ';
v_sql := v_sql||'                           + ROUND (SUM (src.MP_L_LMT * days), 4) ';
v_sql := v_sql||'                              LIMIT_ADD14, ';
v_sql := v_sql||'                           ROUND (SUM (BAL * days), 4) BAL, ';
v_sql := v_sql||'                           ROUND (SUM (BAL_ADD14 * days), 4) BAL_ADD14, ';
v_sql := v_sql||'                           ROUND (SUM (BAL_WO_AUTHS * days), 4) BAL_WO_AUTHS ';
v_sql := v_sql||'                      FROM (SELECT S.XACCOUNT XACCOUNT, ';
v_sql := v_sql||'                                   S.CUSTR_NBR CUSTR_NBR, ';
v_sql := v_sql||'                                   floor (CASE ';
v_sql := v_sql||'                                   WHEN S.TLMT_END = ''0'' THEN 0 ';
v_sql := v_sql||'                                   WHEN (S.TLMT_END + 0) <= S.TLMT_BEG THEN 0 ';
v_sql := v_sql||'                                      WHEN     (S.TLMT_BEG + 0) <= ';
v_sql := v_sql||'                                                     toDate(S.END_DATE, ';
v_sql := v_sql||'                                                              ''yyyymmdd'') ';
v_sql := v_sql||'                                           AND (S.TLMT_END + 0) > ';
v_sql := v_sql||'                                                     toDate(S.END_DATE, ';
v_sql := v_sql||'                                                              ''yyyymmdd'') ';
v_sql := v_sql||'                                      THEN ';
v_sql := v_sql||'                                           S.END_DATE ';
v_sql := v_sql||'                                         - CASE ';
v_sql := v_sql||'                                              WHEN (S.START_DATE + 0) <= ';
v_sql := v_sql||'                                                      toDate(S.TLMT_BEG, ';
v_sql := v_sql||'                                                               ''yyyymmdd'') ';
v_sql := v_sql||'                                              THEN ';
v_sql := v_sql||'                                                 toDate(S.TLMT_BEG, ';
v_sql := v_sql||'                                                          ''yyyymmdd'') ';
v_sql := v_sql||'                                              ELSE ';
v_sql := v_sql||'                                                 CASE ';
v_sql := v_sql||'                                                    WHEN todate(S.START_DATE,''yyyy-mm-dd'') > ';
v_sql := v_sql||'                                                            ADD_MONTHS ( ';
v_sql := v_sql||'                                                               toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), ';
v_sql := v_sql||'                                                               -1) ';
v_sql := v_sql||'                                                    THEN ';
v_sql := v_sql||'                                                       S.START_DATE ';
v_sql := v_sql||'                                                    ELSE ';
v_sql := v_sql||'                                                       ADD_MONTHS ( ';
v_sql := v_sql||'                                                          toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), ';
v_sql := v_sql||'                                                          -1) ';
v_sql := v_sql||'                                                 END ';
v_sql := v_sql||'                                           END ';
v_sql := v_sql||'                                       WHEN     (S.TLMT_BEG + 0) <= ';
v_sql := v_sql||'                                                             toDate(S.END_DATE, ';
v_sql := v_sql||'                                                                      ''yyyymmdd'') ';
v_sql := v_sql||'                                                   AND (S.TLMT_END + 0) <= ';
v_sql := v_sql||'                                                             toDate(S.END_DATE, ';
v_sql := v_sql||'                                                                      ''yyyymmdd'') ';
v_sql := v_sql||'                                              THEN ';
v_sql := v_sql||'                                                         toDate(S.TLMT_END, ';
v_sql := v_sql||'                                                                  ''yyyymmdd'') ';
v_sql := v_sql||'                                                 - ';
v_sql := v_sql||'                                                         CASE ';
v_sql := v_sql||'                                                                 WHEN (S.START_DATE + 0) <= ';
v_sql := v_sql||'                                                                         toDate(S.TLMT_BEG, ';
v_sql := v_sql||'                                                                                  ''yyyymmdd'') ';
v_sql := v_sql||'                                                                 THEN ';
v_sql := v_sql||'                                                                    toDate(S.TLMT_BEG, ';
v_sql := v_sql||'                                                                             ''yyyymmdd'') ';
v_sql := v_sql||'                                                                 ELSE ';
v_sql := v_sql||'                                                                    CASE ';
v_sql := v_sql||'                                                                       WHEN todate(S.START_DATE,''yyyy-mm-dd'') > ';
v_sql := v_sql||'                                                                               ADD_MONTHS ( ';
v_sql := v_sql||'                                                                                  toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), ';
v_sql := v_sql||'                                                                                  -1) ';
v_sql := v_sql||'                                                                       THEN ';
v_sql := v_sql||'                                                                          S.START_DATE ';
v_sql := v_sql||'                                                                       ELSE ';
v_sql := v_sql||'                                                                          ADD_MONTHS ( ';
v_sql := v_sql||'                                                                             toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), ';
v_sql := v_sql||'                                                                             -1) ';
v_sql := v_sql||'                                                                    END ';
v_sql := v_sql||'                                                          END ';
v_sql := v_sql||'                                          ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                   END ';
v_sql := v_sql||'                                    )  tempDays, ';
v_sql := v_sql||'                                   S.TEMP_LIMIT TEMP_LIMIT, ';
v_sql := v_sql||'                                   S.CRED_LIMIT CRED_LIMIT, ';
v_sql := v_sql||'                                   A.MP_L_LMT MP_L_LMT, ';
v_sql := v_sql||'                                  date_diff (   S.END_DATE ';
v_sql := v_sql||'                                   , CASE ';
v_sql := v_sql||'                                        WHEN todate(S.START_DATE,''yyyy-mm-dd'') < ';
v_sql := v_sql||'                                                ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), ';
v_sql := v_sql||'                                                            -1) ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           todate(S.START_DATE,''yyyy-mm-dd'') ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                      ) days, ';
v_sql := v_sql||'                                     COAL (S.STM_BALFRE, 0) ';
v_sql := v_sql||'                                   + ';
v_sql := v_sql||'                                    CASE ';
v_sql := v_sql||'                                        WHEN S.STMBALINTFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.STM_BALINT ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + COAL (S.STM_BALMP, 0) ';
v_sql := v_sql||'                                   + COAL (S.STM_BALORI, 0) ';
v_sql := v_sql||'                                   + COAL (S.STM_NOINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_CMPINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_FREE, 0) ';
v_sql := v_sql||'                                   + CASE ';
v_sql := v_sql||'                                        WHEN S.BAL_INTFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.BAL_INT ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + CASE ';
v_sql := v_sql||'                                        WHEN S.BAL_MPFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.BAL_MP ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + COAL (S.BAL_ORINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_NOINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.Auths_Amt, 0) ';
v_sql := v_sql||'                                   + COAL (S.MP_REM_PPL, 0) ';
v_sql := v_sql||'                                   + COAL (A.MP_BAL, 0) ';
v_sql := v_sql||'                                   + COAL (S.MP_AUTHS, 0) ';
v_sql := v_sql||'                                   + COAL (A.MP_AUTHS, 0) ';
v_sql := v_sql||'                                      AS BAL_ADD14, ';
v_sql := v_sql||'                                     COAL (S.STM_BALFRE, 0) ';
v_sql := v_sql||'                                   + ';
v_sql := v_sql||'                                    CASE ';
v_sql := v_sql||'                                        WHEN S.STMBALINTFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.STM_BALINT ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + COAL (S.STM_BALMP, 0) ';
v_sql := v_sql||'                                   + COAL (S.STM_BALORI, 0) ';
v_sql := v_sql||'                                   + COAL (S.STM_NOINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_CMPINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_FREE, 0) ';
v_sql := v_sql||'                                   + CASE ';
v_sql := v_sql||'                                        WHEN S.BAL_INTFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.BAL_INT ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + CASE ';
v_sql := v_sql||'                                        WHEN S.BAL_MPFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.BAL_MP ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + COAL (S.BAL_ORINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_NOINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.Auths_Amt, 0) ';
v_sql := v_sql||'                                   + COAL (S.MP_REM_PPL, 0) ';
v_sql := v_sql||'                                   + COAL (S.MP_AUTHS, 0) ';
v_sql := v_sql||'                                      AS BAL , ';
v_sql := v_sql||'                                    COAL (S.STM_BALFRE, 0) ';
v_sql := v_sql||'                                   + ';
v_sql := v_sql||'                                    CASE ';
v_sql := v_sql||'                                        WHEN S.STMBALINTFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.STM_BALINT ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + COAL (S.STM_BALMP, 0) ';
v_sql := v_sql||'                                   + COAL (S.STM_BALORI, 0) ';
v_sql := v_sql||'                                   + COAL (S.STM_NOINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_CMPINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_FREE, 0) ';
v_sql := v_sql||'                                   + CASE ';
v_sql := v_sql||'                                        WHEN S.BAL_INTFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.BAL_INT ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + CASE ';
v_sql := v_sql||'                                        WHEN S.BAL_MPFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.BAL_MP ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + COAL (S.BAL_ORINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_NOINT, 0) ';
v_sql := v_sql||'                                      AS BAL_WO_AUTHS ';
v_sql := v_sql||'                              FROM (select t.* from V_FDM_S24_ACCT t left join ';
v_sql := v_sql||' (select C.code_value,C.bank_id from ccam_codes C, tbl_banks B  where B.bankid = C.bank_id and  C.code_type = ''TSZH'') ta ';
v_sql := v_sql||'                              on t.CATEGORY = ta.code_value where ta.bank_id is null ) s ';
v_sql := v_sql||'                                   LEFT JOIN V_FDM_S24_ACCA a ';
v_sql := v_sql||'                                      ON     S.START_DATE = A.START_DATE ';
v_sql := v_sql||'                                         AND S.XACCOUNT = A.XACCOUNT ';
v_sql := v_sql||'                                         AND todate(A.END_DATE,''yyyy-mm-dd'') >= ';
v_sql := v_sql||'                                                ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), ';
v_sql := v_sql||'                                                            -1) ';
v_sql := v_sql||'                                         AND todate(A.END_DATE,''yyyy-mm-dd'') < date_add(toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), 1) ';
v_sql := v_sql||' LEFT JOIN (select C.code_value,C.bank_id from ccam_codes C, tbl_banks B  where B.bankid = C.bank_id and  C.code_type = ''TSCP'') tb ';
v_sql := v_sql||'                                      ON     S.PROD_NBR = tb.code_value ';
v_sql := v_sql||'                             WHERE     todate(S.END_DATE,''yyyy-mm-dd'') >= ';
v_sql := v_sql||'                                          ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                                   AND todate(S.END_DATE,''yyyy-mm-dd'') < date_add(toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), 1) ';
v_sql := v_sql||'                                   AND tb.bank_id is null ';
v_sql := v_sql||'                                                          ) src ';
v_sql := v_sql||'                  GROUP BY SRC.XACCOUNT, SRC.CUSTR_NBR) final ';
v_sql := v_sql||'        GROUP BY final.CUSTR_NBR) acct left join ';
v_sql := v_sql||'       (  SELECT T.CUSTR_NBR, ';
v_sql := v_sql||'                 SUM ( ';
v_sql := v_sql||'                      (    COAL (T2.STM_BALFRE, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       + ';
v_sql := v_sql||'                        CASE ';
v_sql := v_sql||'                            WHEN T2.STMBALINTFLAG = ''+'' ';
v_sql := v_sql||'                            THEN ';
v_sql := v_sql||'                                 COAL (T2.STM_BALINT, 0) ';
v_sql := v_sql||'                               * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                            ELSE ';
v_sql := v_sql||'                               0 ';
v_sql := v_sql||'                         END ';
v_sql := v_sql||'                       +   COAL (T2.STM_BALMP, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.STM_BALORI, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.STM_NOINT, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.BAL_CMPINT, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.BAL_FREE, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       + CASE ';
v_sql := v_sql||'                            WHEN T2.BALINTFLAG = ''+'' ';
v_sql := v_sql||'                            THEN ';
v_sql := v_sql||'                                 COAL (T2.BAL_INT, 0) ';
v_sql := v_sql||'                               * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                            ELSE ';
v_sql := v_sql||'                               0 ';
v_sql := v_sql||'                         END ';
v_sql := v_sql||'                       +   COAL (T2.BAL_MP, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.BAL_ORINT, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.BAL_NOINT, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.Auths_Amt, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.MP_REM_PPL, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.MP_AUTHS, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                                                    ) ';
v_sql := v_sql||'                    * (  T2.END_DATE ';
v_sql := v_sql||'                       - CASE ';
v_sql := v_sql||'                            WHEN todate(t.START_DATE,''yyyy-mm-dd'') < ';
v_sql := v_sql||'                                    ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                            THEN ';
v_sql := v_sql||'                               ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                            ELSE ';
v_sql := v_sql||'                               t.START_DATE ';
v_sql := v_sql||'                         END)) ';
v_sql := v_sql||'                    AS BAL_ADD14, ';
v_sql := v_sql||'                 SUM ( ';
v_sql := v_sql||'                    (    COAL (T2.STM_BALFRE, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     + ';
v_sql := v_sql||'                      CASE ';
v_sql := v_sql||'                          WHEN T2.STMBALINTFLAG = ''+'' ';
v_sql := v_sql||'                          THEN ';
v_sql := v_sql||'                               COAL (T2.STM_BALINT, 0) ';
v_sql := v_sql||'                             * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                          ELSE ';
v_sql := v_sql||'                             0 ';
v_sql := v_sql||'                       END ';
v_sql := v_sql||'                     +   COAL (T2.STM_BALMP, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.STM_BALORI, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.STM_NOINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_CMPINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_FREE, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     + CASE ';
v_sql := v_sql||'                          WHEN T2.BALINTFLAG = ''+'' ';
v_sql := v_sql||'                          THEN ';
v_sql := v_sql||'                               COAL (T2.BAL_INT, 0) ';
v_sql := v_sql||'                             * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                          ELSE ';
v_sql := v_sql||'                             0 ';
v_sql := v_sql||'                       END ';
v_sql := v_sql||'                     +   COAL (T2.BAL_MP, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_ORINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_NOINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.Auths_Amt, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.MP_REM_PPL, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.MP_AUTHS, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       * (  T2.END_DATE ';
v_sql := v_sql||'                          - CASE ';
v_sql := v_sql||'                               WHEN todate(t.START_DATE,''yyyy-mm-dd'') < ';
v_sql := v_sql||'                                       ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                               THEN ';
v_sql := v_sql||'                                  ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                               ELSE ';
v_sql := v_sql||'                                  t.START_DATE ';
v_sql := v_sql||'                            END))) ';
v_sql := v_sql||'                    AS BAL , ';
v_sql := v_sql||'                                            SUM ( ';
v_sql := v_sql||'                    (    COAL (T2.STM_BALFRE, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     + ';
v_sql := v_sql||'                      CASE ';
v_sql := v_sql||'                          WHEN T2.STMBALINTFLAG = ''+'' ';
v_sql := v_sql||'                          THEN ';
v_sql := v_sql||'                               COAL (T2.STM_BALINT, 0) ';
v_sql := v_sql||'                             * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                          ELSE ';
v_sql := v_sql||'                             0 ';
v_sql := v_sql||'                       END ';
v_sql := v_sql||'                     +   COAL (T2.STM_BALMP, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.STM_BALORI, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.STM_NOINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_CMPINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_FREE, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     + CASE ';
v_sql := v_sql||'                          WHEN T2.BALINTFLAG = ''+'' ';
v_sql := v_sql||'                          THEN ';
v_sql := v_sql||'                               COAL (T2.BAL_INT, 0) ';
v_sql := v_sql||'                             * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                          ELSE ';
v_sql := v_sql||'                             0 ';
v_sql := v_sql||'                       END ';
v_sql := v_sql||'                     +   COAL (T2.BAL_MP, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_ORINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_NOINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.Auths_Amt, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.MP_REM_PPL, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.MP_AUTHS, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       * (  T2.END_DATE ';
v_sql := v_sql||'                          - CASE ';
v_sql := v_sql||'                               WHEN todate(t.START_DATE,''yyyy-mm-dd'') < ';
v_sql := v_sql||'                                       ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                               THEN ';
v_sql := v_sql||'                                  ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                               ELSE ';
v_sql := v_sql||'                                  t.START_DATE ';
v_sql := v_sql||'                            END))) ';
v_sql := v_sql||'                    AS BAL_WO_AUTHS ';
v_sql := v_sql||'            FROM V_FDM_S24_ACCX T2 ';
v_sql := v_sql||'                 INNER JOIN FDM_S24_CUR_ACCT t ';
v_sql := v_sql||'                    ON t.XACCOUNT = T2.XACCOUNT ';
v_sql := v_sql||'                 LEFT JOIN V_PRMXR B ';
v_sql := v_sql||'                    ON T2.BANK = B.BANK AND T2.CURR_NUM = B.CURR_NUM ';
v_sql := v_sql||' LEFT JOIN (select C.code_value,C.bank_id from ccam_codes C, tbl_banks B  where B.bankid = C.bank_id and  C.code_type = ''TSZH'') tc ';
v_sql := v_sql||'                    ON T2.CATEGORY = tc.code_value ';
v_sql := v_sql||'           WHERE     todate(T2.END_DATE,''yyyy-mm-dd'') >= ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                 AND todate(T2.END_DATE,''yyyy-mm-dd'') < date_add(toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), 1) ';
v_sql := v_sql||'                 AND tc.bank_id is null ';
v_sql := v_sql||'        GROUP BY T.CUSTR_NBR) acca on ACCT.CUSTR_NBR = acca.CUSTR_NBR ';

    DBMS_OUTPUT.PUT_LINE('prc_generate_limitusage_data5 after:==========' || v_sql);
  
    execute immediate v_sql;

    SET result = '1';
  
    DBMS_OUTPUT.PUT_LINE('prc_generate_limitusage_data5 over:==========success!');

--EXCEPTION WHEN OTHERS THEN
 -- DBMS_OUTPUT.PUT_LINE('prc_generate_limitusage_data5 Error');
END;

CREATE OR REPLACE PROCEDURE prc_generate_limitusage_data_6 (IN YWDATE STRING, OUT result STRING)
BEGIN

DECLARE
  v_sql      varchar(100000);
  
  --SET YWDATE = '2016-05-17';
  DBMS_OUTPUT.PUT_LINE ('YWDATE ===' || YWDATE);
  SET result = '0';

  DBMS_OUTPUT.PUT_LINE ('prc_generate_limitusage_data_6 START');
     
   DBMS_OUTPUT.PUT_LINE('prc_generate_limitusage_data_6 before:=========' || v_sql);
v_sql := ' INSERT INTO TEMP_CUSTNUM_LimitUsage_6 ';
v_sql := v_sql||' SELECT acct.CUSTR_NBR, ';
v_sql := v_sql||'       acct.LIMIT, ';
v_sql := v_sql||'       acct.limit_add14, ';
v_sql := v_sql||'       (acct.bal + COAL (ACCA.BAL, 0)) AS bal, ';
v_sql := v_sql||'       (acct.bal_add14 + COAL (ACCA.BAL_add14, 0)) AS bal_add14, ';
v_sql := v_sql||'       (acct.BAL_WO_AUTHS + COAL (ACCA.BAL_WO_AUTHS, 0)) AS BAL_WO_AUTHS, ';
v_sql := v_sql||'       date_diff(toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), ';
v_sql := v_sql||'       ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''),-1)) ';
v_sql := v_sql||' FROM (  SELECT final.CUSTR_NBR AS CUSTR_NBR, ';
v_sql := v_sql||'                 MAX (final.LIMIT + 0) AS LIMIT, ';
v_sql := v_sql||'                 MAX (final.limit_add14 + 0) AS limit_add14, ';
v_sql := v_sql||'                 SUM (final.bal) AS bal, ';
v_sql := v_sql||'                 SUM (final.bal_add14) AS bal_add14, ';
v_sql := v_sql||'                 SUM (final.BAL_WO_AUTHS) AS BAL_WO_AUTHS ';
v_sql := v_sql||'            FROM (  SELECT SRC.XACCOUNT AS XACCOUNT, ';
v_sql := v_sql||'                           SRC.CUSTR_NBR AS CUSTR_NBR, ';
v_sql := v_sql||'                           ROUND ( ';
v_sql := v_sql||'                              SUM ( ';
v_sql := v_sql||'                                 CASE ';
v_sql := v_sql||'                                    WHEN src.tempDays = 0 ';
v_sql := v_sql||'                                    THEN ';
v_sql := v_sql||'                                       src.days * CRED_LIMIT ';
v_sql := v_sql||'                                    ELSE ';
v_sql := v_sql||'                                           (src.days - src.tempDays) ';
v_sql := v_sql||'                                         * src.CRED_LIMIT ';
v_sql := v_sql||'                                       + src.tempDays * src.TEMP_LIMIT ';
v_sql := v_sql||'                                 END), ';
v_sql := v_sql||'                              4) ';
v_sql := v_sql||'                              LIMIT, ';
v_sql := v_sql||'                             ROUND ( ';
v_sql := v_sql||'                                SUM ( ';
v_sql := v_sql||'                                   CASE ';
v_sql := v_sql||'                                      WHEN src.tempDays = 0 ';
v_sql := v_sql||'                                      THEN ';
v_sql := v_sql||'                                         src.days * CRED_LIMIT ';
v_sql := v_sql||'                                      ELSE ';
v_sql := v_sql||'                                             (src.days - src.tempDays) ';
v_sql := v_sql||'                                           * src.CRED_LIMIT ';
v_sql := v_sql||'                                         + src.tempDays * src.TEMP_LIMIT ';
v_sql := v_sql||'                                   END), ';
v_sql := v_sql||'                                4) ';
v_sql := v_sql||'                           + ROUND (SUM (src.MP_L_LMT * days), 4) ';
v_sql := v_sql||'                              LIMIT_ADD14, ';
v_sql := v_sql||'                           ROUND (SUM (BAL * days), 4) BAL, ';
v_sql := v_sql||'                           ROUND (SUM (BAL_ADD14 * days), 4) BAL_ADD14, ';
v_sql := v_sql||'                           ROUND (SUM (BAL_WO_AUTHS * days), 4) BAL_WO_AUTHS ';
v_sql := v_sql||'                      FROM (SELECT S.XACCOUNT XACCOUNT, ';
v_sql := v_sql||'                                   S.CUSTR_NBR CUSTR_NBR, ';
v_sql := v_sql||'                                   floor (CASE ';
v_sql := v_sql||'                                   WHEN S.TLMT_END = ''0'' THEN 0 ';
v_sql := v_sql||'                                   WHEN (S.TLMT_END + 0) <= S.TLMT_BEG THEN 0 ';
v_sql := v_sql||'                                      WHEN     (S.TLMT_BEG + 0) <= ';
v_sql := v_sql||'                                                     toDate(S.END_DATE, ';
v_sql := v_sql||'                                                              ''yyyymmdd'') ';
v_sql := v_sql||'                                           AND (S.TLMT_END + 0) > ';
v_sql := v_sql||'                                                     toDate(S.END_DATE, ';
v_sql := v_sql||'                                                              ''yyyymmdd'') ';
v_sql := v_sql||'                                      THEN ';
v_sql := v_sql||'                                           S.END_DATE ';
v_sql := v_sql||'                                         - CASE ';
v_sql := v_sql||'                                              WHEN (S.START_DATE + 0) <= ';
v_sql := v_sql||'                                                      toDate(S.TLMT_BEG, ';
v_sql := v_sql||'                                                               ''yyyymmdd'') ';
v_sql := v_sql||'                                              THEN ';
v_sql := v_sql||'                                                 toDate(S.TLMT_BEG, ';
v_sql := v_sql||'                                                          ''yyyymmdd'') ';
v_sql := v_sql||'                                              ELSE ';
v_sql := v_sql||'                                                 CASE ';
v_sql := v_sql||'                                                    WHEN todate(S.START_DATE,''yyyy-mm-dd'') > ';
v_sql := v_sql||'                                                            ADD_MONTHS ( ';
v_sql := v_sql||'                                                               toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), ';
v_sql := v_sql||'                                                               -1) ';
v_sql := v_sql||'                                                    THEN ';
v_sql := v_sql||'                                                       S.START_DATE ';
v_sql := v_sql||'                                                    ELSE ';
v_sql := v_sql||'                                                       ADD_MONTHS ( ';
v_sql := v_sql||'                                                          toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), ';
v_sql := v_sql||'                                                          -1) ';
v_sql := v_sql||'                                                 END ';
v_sql := v_sql||'                                           END ';
v_sql := v_sql||'                                       WHEN     (S.TLMT_BEG + 0) <= '; 
v_sql := v_sql||'                                                             toDate(S.END_DATE, ';
v_sql := v_sql||'                                                                      ''yyyymmdd'') ';
v_sql := v_sql||'                                                   AND (S.TLMT_END + 0) <= ';
v_sql := v_sql||'                                                             toDate(S.END_DATE, ';
v_sql := v_sql||'                                                                      ''yyyymmdd'') ';
v_sql := v_sql||'                                              THEN ';
v_sql := v_sql||'                                                         toDate(S.TLMT_END, ';
v_sql := v_sql||'                                                                  ''yyyymmdd'') ';
v_sql := v_sql||'                                                 - ';
v_sql := v_sql||'                                                         CASE ';
v_sql := v_sql||'                                                                 WHEN (S.START_DATE + 0) <= ';
v_sql := v_sql||'                                                                         toDate(S.TLMT_BEG, ';
v_sql := v_sql||'                                                                                  ''yyyymmdd'') ';
v_sql := v_sql||'                                                                 THEN ';
v_sql := v_sql||'                                                                    toDate(S.TLMT_BEG, ';
v_sql := v_sql||'                                                                             ''yyyymmdd'') ';
v_sql := v_sql||'                                                                 ELSE ';
v_sql := v_sql||'                                                                    CASE ';
v_sql := v_sql||'                                                                       WHEN todate(S.START_DATE,''yyyy-mm-dd'') > ';
v_sql := v_sql||'                                                                               ADD_MONTHS ( ';
v_sql := v_sql||'                                                                                  toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), ';
v_sql := v_sql||'                                                                                  -1) ';
v_sql := v_sql||'                                                                       THEN ';
v_sql := v_sql||'                                                                          S.START_DATE ';
v_sql := v_sql||'                                                                       ELSE ';
v_sql := v_sql||'                                                                          ADD_MONTHS ( ';
v_sql := v_sql||'                                                                             toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), ';
v_sql := v_sql||'                                                                             -1) ';
v_sql := v_sql||'                                                                    END ';
v_sql := v_sql||'                                                          END ';
v_sql := v_sql||'                                          ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                   END ';
v_sql := v_sql||'                                    )  tempDays, ';
v_sql := v_sql||'                                   S.TEMP_LIMIT TEMP_LIMIT, ';
v_sql := v_sql||'                                   S.CRED_LIMIT CRED_LIMIT, ';
v_sql := v_sql||'                                   A.MP_L_LMT MP_L_LMT, ';
v_sql := v_sql||'                                  date_diff (   S.END_DATE ';
v_sql := v_sql||'                                   , CASE ';
v_sql := v_sql||'                                        WHEN todate(S.START_DATE,''yyyy-mm-dd'') < ';
v_sql := v_sql||'                                                ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), ';
v_sql := v_sql||'                                                            -1) ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           todate(S.START_DATE,''yyyy-mm-dd'') ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                      ) days, ';
v_sql := v_sql||'                                     COAL (S.STM_BALFRE, 0) ';
v_sql := v_sql||'                                   + ';
v_sql := v_sql||'                                    CASE ';
v_sql := v_sql||'                                        WHEN S.STMBALINTFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.STM_BALINT ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + COAL (S.STM_BALMP, 0) ';
v_sql := v_sql||'                                   + COAL (S.STM_BALORI, 0) ';
v_sql := v_sql||'                                   + COAL (S.STM_NOINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_CMPINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_FREE, 0) ';
v_sql := v_sql||'                                   + CASE ';
v_sql := v_sql||'                                        WHEN S.BAL_INTFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.BAL_INT ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + CASE ';
v_sql := v_sql||'                                        WHEN S.BAL_MPFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.BAL_MP ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + COAL (S.BAL_ORINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_NOINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.Auths_Amt, 0) ';
v_sql := v_sql||'                                   + COAL (S.MP_REM_PPL, 0) ';
v_sql := v_sql||'                                   + COAL (A.MP_BAL, 0) ';
v_sql := v_sql||'                                   + COAL (S.MP_AUTHS, 0) ';
v_sql := v_sql||'                                   + COAL (A.MP_AUTHS, 0) ';
v_sql := v_sql||'                                      AS BAL_ADD14, ';
v_sql := v_sql||'                                     COAL (S.STM_BALFRE, 0) ';
v_sql := v_sql||'                                   + ';
v_sql := v_sql||'                                    CASE ';
v_sql := v_sql||'                                        WHEN S.STMBALINTFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.STM_BALINT ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + COAL (S.STM_BALMP, 0) ';
v_sql := v_sql||'                                   + COAL (S.STM_BALORI, 0) ';
v_sql := v_sql||'                                   + COAL (S.STM_NOINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_CMPINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_FREE, 0) ';
v_sql := v_sql||'                                   + CASE ';
v_sql := v_sql||'                                        WHEN S.BAL_INTFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.BAL_INT ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + CASE ';
v_sql := v_sql||'                                        WHEN S.BAL_MPFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.BAL_MP ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + COAL (S.BAL_ORINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_NOINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.Auths_Amt, 0) ';
v_sql := v_sql||'                                   + COAL (S.MP_REM_PPL, 0) ';
v_sql := v_sql||'                                   + COAL (S.MP_AUTHS, 0) ';
v_sql := v_sql||'                                      AS BAL , ';
v_sql := v_sql||'                                    COAL (S.STM_BALFRE, 0) ';
v_sql := v_sql||'                                   + ';
v_sql := v_sql||'                                    CASE ';
v_sql := v_sql||'                                        WHEN S.STMBALINTFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.STM_BALINT ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + COAL (S.STM_BALMP, 0) ';
v_sql := v_sql||'                                   + COAL (S.STM_BALORI, 0) ';
v_sql := v_sql||'                                   + COAL (S.STM_NOINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_CMPINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_FREE, 0) ';
v_sql := v_sql||'                                   + CASE ';
v_sql := v_sql||'                                        WHEN S.BAL_INTFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.BAL_INT ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + CASE ';
v_sql := v_sql||'                                        WHEN S.BAL_MPFLAG = ''+'' ';
v_sql := v_sql||'                                        THEN ';
v_sql := v_sql||'                                           S.BAL_MP ';
v_sql := v_sql||'                                        ELSE ';
v_sql := v_sql||'                                           0 ';
v_sql := v_sql||'                                     END ';
v_sql := v_sql||'                                   + COAL (S.BAL_ORINT, 0) ';
v_sql := v_sql||'                                   + COAL (S.BAL_NOINT, 0) ';
v_sql := v_sql||'                                      AS BAL_WO_AUTHS ';
v_sql := v_sql||'                              FROM (select t.* from V_FDM_S24_ACCT t left join ';
v_sql := v_sql||' (select C.code_value,C.bank_id from ccam_codes C, tbl_banks B  where B.bankid = C.bank_id and  C.code_type = ''TSZH'') ta ';
v_sql := v_sql||'                              on t.CATEGORY = ta.code_value where ta.bank_id is null ) s ';
v_sql := v_sql||'                                   LEFT JOIN V_FDM_S24_ACCA a ';
v_sql := v_sql||'                                      ON     S.START_DATE = A.START_DATE ';
v_sql := v_sql||'                                         AND S.XACCOUNT = A.XACCOUNT ';
v_sql := v_sql||'                                         AND todate(A.END_DATE,''yyyy-mm-dd'') >= ';
v_sql := v_sql||'                                                ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), ';
v_sql := v_sql||'                                                            -1) ';
v_sql := v_sql||'                                         AND todate(A.END_DATE,''yyyy-mm-dd'') < date_add(toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), 1) ';
v_sql := v_sql||' LEFT JOIN (select C.code_value,C.bank_id from ccam_codes C, tbl_banks B  where B.bankid = C.bank_id and  C.code_type = ''TSCP'') tb ';
v_sql := v_sql||'                                      ON     S.PROD_NBR = tb.code_value ';
v_sql := v_sql||'                             WHERE     todate(S.END_DATE,''yyyy-mm-dd'') >= ';
v_sql := v_sql||'                                          ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                                   AND todate(S.END_DATE,''yyyy-mm-dd'') < date_add(toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), 1) ';
v_sql := v_sql||'                                   AND tb.bank_id is null ';
v_sql := v_sql||'                                                          ) src ';
v_sql := v_sql||'                  GROUP BY SRC.XACCOUNT, SRC.CUSTR_NBR) final ';
v_sql := v_sql||'        GROUP BY final.CUSTR_NBR) acct left join ';
v_sql := v_sql||'       (  SELECT T.CUSTR_NBR, ';
v_sql := v_sql||'                 SUM ( ';
v_sql := v_sql||'                      (    COAL (T2.STM_BALFRE, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       + ';
v_sql := v_sql||'                        CASE ';
v_sql := v_sql||'                            WHEN T2.STMBALINTFLAG = ''+'' ';
v_sql := v_sql||'                            THEN ';
v_sql := v_sql||'                                 COAL (T2.STM_BALINT, 0) ';
v_sql := v_sql||'                               * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                            ELSE ';
v_sql := v_sql||'                               0 ';
v_sql := v_sql||'                         END ';
v_sql := v_sql||'                       +   COAL (T2.STM_BALMP, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.STM_BALORI, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.STM_NOINT, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.BAL_CMPINT, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.BAL_FREE, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       + CASE ';
v_sql := v_sql||'                            WHEN T2.BALINTFLAG = ''+'' ';
v_sql := v_sql||'                            THEN ';
v_sql := v_sql||'                                 COAL (T2.BAL_INT, 0) ';
v_sql := v_sql||'                               * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                            ELSE ';
v_sql := v_sql||'                               0 ';
v_sql := v_sql||'                         END ';
v_sql := v_sql||'                       +   COAL (T2.BAL_MP, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.BAL_ORINT, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.BAL_NOINT, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.Auths_Amt, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.MP_REM_PPL, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       +   COAL (T2.MP_AUTHS, 0) ';
v_sql := v_sql||'                         * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                                                    ) ';
v_sql := v_sql||'                    * (  T2.END_DATE ';
v_sql := v_sql||'                       - CASE ';
v_sql := v_sql||'                            WHEN todate(t.START_DATE,''yyyy-mm-dd'') < ';
v_sql := v_sql||'                                    ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                            THEN ';
v_sql := v_sql||'                               ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                            ELSE ';
v_sql := v_sql||'                               t.START_DATE ';
v_sql := v_sql||'                         END)) ';
v_sql := v_sql||'                    AS BAL_ADD14, ';
v_sql := v_sql||'                 SUM ( ';
v_sql := v_sql||'                    (    COAL (T2.STM_BALFRE, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     + ';
v_sql := v_sql||'                      CASE ';
v_sql := v_sql||'                          WHEN T2.STMBALINTFLAG = ''+'' ';
v_sql := v_sql||'                          THEN ';
v_sql := v_sql||'                               COAL (T2.STM_BALINT, 0) ';
v_sql := v_sql||'                             * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                          ELSE ';
v_sql := v_sql||'                             0 ';
v_sql := v_sql||'                       END ';
v_sql := v_sql||'                     +   COAL (T2.STM_BALMP, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.STM_BALORI, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.STM_NOINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_CMPINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_FREE, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     + CASE ';
v_sql := v_sql||'                          WHEN T2.BALINTFLAG = ''+'' ';
v_sql := v_sql||'                          THEN ';
v_sql := v_sql||'                               COAL (T2.BAL_INT, 0) ';
v_sql := v_sql||'                             * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                          ELSE ';
v_sql := v_sql||'                             0 ';
v_sql := v_sql||'                       END ';
v_sql := v_sql||'                     +   COAL (T2.BAL_MP, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_ORINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_NOINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.Auths_Amt, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.MP_REM_PPL, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.MP_AUTHS, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       * (  T2.END_DATE ';
v_sql := v_sql||'                          - CASE ';
v_sql := v_sql||'                               WHEN todate(t.START_DATE,''yyyy-mm-dd'') < ';
v_sql := v_sql||'                                       ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                               THEN ';
v_sql := v_sql||'                                  ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                               ELSE ';
v_sql := v_sql||'                                  t.START_DATE ';
v_sql := v_sql||'                            END))) ';
v_sql := v_sql||'                    AS BAL , ';
v_sql := v_sql||'                                            SUM ( ';
v_sql := v_sql||'                    (    COAL (T2.STM_BALFRE, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     + ';
v_sql := v_sql||'                      CASE ';
v_sql := v_sql||'                          WHEN T2.STMBALINTFLAG = ''+'' ';
v_sql := v_sql||'                          THEN ';
v_sql := v_sql||'                               COAL (T2.STM_BALINT, 0) ';
v_sql := v_sql||'                             * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                          ELSE ';
v_sql := v_sql||'                             0 ';
v_sql := v_sql||'                       END ';
v_sql := v_sql||'                     +   COAL (T2.STM_BALMP, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.STM_BALORI, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.STM_NOINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_CMPINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_FREE, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     + CASE ';
v_sql := v_sql||'                          WHEN T2.BALINTFLAG = ''+'' ';
v_sql := v_sql||'                          THEN ';
v_sql := v_sql||'                               COAL (T2.BAL_INT, 0) ';
v_sql := v_sql||'                             * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                          ELSE ';
v_sql := v_sql||'                             0 ';
v_sql := v_sql||'                       END ';
v_sql := v_sql||'                     +   COAL (T2.BAL_MP, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_ORINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.BAL_NOINT, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.Auths_Amt, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.MP_REM_PPL, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                     +   COAL (T2.MP_AUTHS, 0) ';
v_sql := v_sql||'                       * COAL (B.RATE_VAL0, 0) ';
v_sql := v_sql||'                       * (  T2.END_DATE ';
v_sql := v_sql||'                          - CASE ';
v_sql := v_sql||'                               WHEN todate(t.START_DATE,''yyyy-mm-dd'') < ';
v_sql := v_sql||'                                       ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                               THEN ';
v_sql := v_sql||'                                  ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                               ELSE ';
v_sql := v_sql||'                                  t.START_DATE ';
v_sql := v_sql||'                            END))) ';
v_sql := v_sql||'                    AS BAL_WO_AUTHS ';
v_sql := v_sql||'            FROM V_FDM_S24_ACCX T2 ';
v_sql := v_sql||'                 INNER JOIN FDM_S24_CUR_ACCT t ';
v_sql := v_sql||'                    ON t.XACCOUNT = T2.XACCOUNT ';
v_sql := v_sql||'                 LEFT JOIN V_PRMXR B ';
v_sql := v_sql||'                    ON T2.BANK = B.BANK AND T2.CURR_NUM = B.CURR_NUM ';
v_sql := v_sql||' LEFT JOIN (select C.code_value,C.bank_id from ccam_codes C, tbl_banks B  where B.bankid = C.bank_id and  C.code_type = ''TSZH'') tc ';
v_sql := v_sql||'                    ON T2.CATEGORY = tc.bank_id ';
v_sql := v_sql||'           WHERE     todate(T2.END_DATE,''yyyy-mm-dd'') >= ADD_MONTHS (toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), -1) ';
v_sql := v_sql||'                 AND todate(T2.END_DATE,''yyyy-mm-dd'') < date_add(toDate('' ' || YWDATE || ' '',''yyyy-mm-dd''), 1) ';
v_sql := v_sql||'                 AND tc.bank_id is null ';
v_sql := v_sql||'        GROUP BY T.CUSTR_NBR) acca on ACCT.CUSTR_NBR = acca.CUSTR_NBR ';

    --DBMS_OUTPUT.PUT_LINE('prc_generate_limitusage_data6 after:==========' || v_sql);
  
    --execute immediate v_sql;

    SET result = '1';
  
    DBMS_OUTPUT.PUT_LINE('prc_generate_limitusage_data6 over:==========success!');

--EXCEPTION WHEN OTHERS THEN
 -- DBMS_OUTPUT.PUT_LINE('prc_generate_limitusage_data6 Error');
END;

CREATE OR REPLACE PROCEDURE PRC_CUSTUM(IN ETL_DATE STRING, OUT RESULT STRING)

BEGIN
DECLARE v_sql31    string;
DECLARE v_sql32    string;

DECLARE v_ETL_DATE string;

DECLARE v_d1 string;
DECLARE v_d2 string;
DECLARE v_d3 string;
DECLARE v_d4 string;
DECLARE v_d5 string;

  DBMS_OUTPUT.PUT_LINE ('PRC_ACCOUNT_INIT START');
  DBMS_OUTPUT.PUT_LINE ('ETL_DATE ==' || ETL_DATE);

  IF ETL_DATE <> ' '
   THEN
      select todate(ETL_DATE,'yyyy-mm-dd') into v_ETL_DATE from dual;
      DBMS_OUTPUT.PUT_LINE ('v_ETL_DATE2==' || v_ETL_DATE);
   ELSE
      DBMS_OUTPUT.PUT_LINE ('V_ETL_DATE ');

      SELECT todate(SYSDATE(),'yyyy-mm-dd') INTO v_ETL_DATE FROM DUAL;
   END IF;

   DBMS_OUTPUT.PUT_LINE ('v_ETL_DATE3 ==' || v_ETL_DATE);

   --
   EXECUTE IMMEDIATE ('truncate table  TEMP_CUSTNUM_LIMITUSAGE');
    
   select month_add(ETL_DATE,-1) into v_d1 from dual ;
   select month_add(ETL_DATE,-2) into v_d2 from dual ;
   select month_add(ETL_DATE,-3) into v_d3 from dual ;
   select month_add(ETL_DATE,-4) into v_d4 from dual ;
   select month_add(ETL_DATE,-5) into v_d5 from dual ;
   
   DBMS_OUTPUT.PUT_LINE ('v_ETL_DATE1 ==' || v_d1);
   DBMS_OUTPUT.PUT_LINE ('v_ETL_DATE2 ==' || v_d2);
   DBMS_OUTPUT.PUT_LINE ('v_ETL_DATE3 ==' || v_d3);
   DBMS_OUTPUT.PUT_LINE ('v_ETL_DATE4 ==' || v_d4);
   DBMS_OUTPUT.PUT_LINE ('v_ETL_DATE5 ==' || v_d5);

   --sysdate format : yyyy-mm-dd
   call PRC_generate_LimitUsage_DATA (3); 
   call PRC_generate_LimitUsage_DATA (6);
   call PRC_generate_LimitUsage_DATA (12);
   call PRC_generate_LimitUsage_DATA_1(v_ETL_DATE);
   call PRC_generate_LimitUsage_DATA_2(v_d1);
   call PRC_generate_LimitUsage_DATA_3(v_d2);
   call PRC_generate_LimitUsage_DATA_4(v_d3);
   call PRC_generate_LimitUsage_DATA_5(v_d4);
   call PRC_generate_LimitUsage_DATA_6(v_d5);

   EXECUTE IMMEDIATE ('truncate table  temp_custum_special');
   
   DBMS_OUTPUT.PUT_LINE('execute INSERT INTO temp_custum_special SELECT * FROM V_CUSTNUM_SPECIAL');

   EXECUTE IMMEDIATE ('INSERT INTO temp_custum_special SELECT * FROM V_CUSTNUM_SPECIAL');

   EXECUTE IMMEDIATE ('truncate table  temp_custum_special_sp');
   
   DBMS_OUTPUT.PUT_LINE('execute INSERT INTO temp_custum_special_sp SELECT * FROM V_CUSTNUM_SPECIAL_sp');

   EXECUTE IMMEDIATE ('INSERT INTO temp_custum_special_sp SELECT * FROM V_CUSTNUM_SPECIAL_sp');

   EXECUTE IMMEDIATE ('truncate table  temp_main_acct');
  
   DBMS_OUTPUT.PUT_LINE('execute INSERT INTO temp_main_acct SELECT * FROM v_main_acct');
 
   EXECUTE IMMEDIATE ('INSERT INTO temp_main_acct SELECT * FROM v_main_acct');

   EXECUTE IMMEDIATE ('truncate table  temp_main_basic');
   
   DBMS_OUTPUT.PUT_LINE('execute INSERT INTO temp_main_basic SELECT * FROM v_main_basic');

   EXECUTE IMMEDIATE ('INSERT INTO temp_main_basic SELECT * FROM v_main_basic');

   EXECUTE IMMEDIATE ('truncate table  temp_main_basic_sp');
   
   DBMS_OUTPUT.PUT_LINE('execute INSERT INTO temp_main_basic_sp SELECT * FROM v_main_basic_sp');

   EXECUTE IMMEDIATE ('INSERT INTO temp_main_basic_sp SELECT * FROM v_main_basic_sp');

   EXECUTE IMMEDIATE ('truncate table  temp_main_account');
   
   DBMS_OUTPUT.PUT_LINE('execute INSERT INTO temp_main_account SELECT * FROM v_main_account');

   EXECUTE IMMEDIATE ('INSERT INTO temp_main_account SELECT * FROM v_main_account');

   EXECUTE IMMEDIATE ('truncate table  TEMP_CUSTUM_FLAG');
   
   DBMS_OUTPUT.PUT_LINE('TEMP_CUSTUM_FLAG before:=========' || v_sql31);
   
v_sql31 := ' INSERT INTO TEMP_CUSTUM_FLAG ';
v_sql31 := v_sql31||' SELECT distinct A.CUSTNUM, ';
v_sql31 := v_sql31||'                 T1.STATUS, ';
v_sql31 := v_sql31||'                 T2.STATUS, ';
v_sql31 := v_sql31||'                 T3.STATUS, ';
v_sql31 := v_sql31||'                 T4.STATUS, ';
v_sql31 := v_sql31||'                 NULL, ';
v_sql31 := v_sql31||'                 NULL, ';
v_sql31 := v_sql31||'                 NULL, ';
v_sql31 := v_sql31||'                 NULL, ';
v_sql31 := v_sql31||'                 NULL, ';
v_sql31 := v_sql31||'                 NULL  ';
v_sql31 := v_sql31||'                  FROM ';
v_sql31 := v_sql31||' special_custum_list  A ';
v_sql31 := v_sql31||' LEFT JOIN (SELECT t.* FROM special_custum_list t,tbl_banks ta where t.FLAG = ''1'' and t.bankid = ta.bankid ) T1 ON T1.CUSTNUM = A.CUSTNUM ';
v_sql31 := v_sql31||' LEFT JOIN (SELECT t.* FROM special_custum_list t,tbl_banks ta where t.FLAG = ''2'' and t.bankid = ta.bankid ) T2 ON T2.CUSTNUM = A.CUSTNUM ';
v_sql31 := v_sql31||' LEFT JOIN (SELECT t.* FROM special_custum_list t,tbl_banks ta where t.FLAG = ''3'' and t.bankid = ta.bankid ) T3 ON T3.CUSTNUM = A.CUSTNUM ';
v_sql31 := v_sql31||' LEFT JOIN (SELECT t.* FROM special_custum_list t,tbl_banks ta where t.FLAG = ''4'' and t.bankid = ta.bankid ) T4 ON T4.CUSTNUM = A.CUSTNUM ';
v_sql31 := v_sql31||' inner JOIN tbl_banks c ';
v_sql31 := v_sql31||' where  A.bankid = c.bankid ';

    DBMS_OUTPUT.PUT_LINE('TEMP_CUSTUM_FLAG after:==========' || v_sql31);

    execute immediate v_sql31;
 
    DBMS_OUTPUT.PUT_LINE('TEMP_CUSTUM_FLAG over:==========success!');
	
    --
    EXECUTE IMMEDIATE ('truncate table CUSTNUM');
	
	DBMS_OUTPUT.PUT_LINE('CUSTNUM before:=========' || v_sql32);

v_sql32 := ' INSERT INTO CUSTNUM ';
v_sql32 := v_sql32||' SELECT T1.CUSTNUM, ';
v_sql32 := v_sql32||'      T1.ACCTNUM, ';
v_sql32 := v_sql32||'      T4.RECORDTYPE, ';
v_sql32 := v_sql32||'      T4.EVENTTYPE, ';
v_sql32 := v_sql32||'      T12.COUNTNUM, ';
v_sql32 := v_sql32||'      T1.CLOSURETYPE, ';
v_sql32 := v_sql32||'      T1.DATECLOSED, ';
v_sql32 := v_sql32||'      T4.EXTRACTTYPE, ';
v_sql32 := v_sql32||'      T7.ACTIVE_DAY, ';
v_sql32 := v_sql32||'      t1.DateLastActive, ';
v_sql32 := v_sql32||'      T2.CURR_TERM, ';
v_sql32 := v_sql32||'      T1.CYCLE_DATE, ';
v_sql32 := v_sql32||'      T3.YYYYMM_BIRTH, ';
v_sql32 := v_sql32||'      T3.YYYYMMDD_BIRTH, ';
v_sql32 := v_sql32||'      T4.AC_LINS_FLG, ';
v_sql32 := v_sql32||'      T2.CU_LINS_CUR_FLG, ';
v_sql32 := v_sql32||'      T4.LINS_LIMIT, ';
v_sql32 := v_sql32||'      T2.LINS_DATE_END, ';
v_sql32 := v_sql32||'      T2.LINS_DATE_ST, ';
v_sql32 := v_sql32||'      T2.LINS_TYPE, ';
v_sql32 := v_sql32||'      T2.LINS_TERM, ';
v_sql32 := v_sql32||'      T2.LINS_REM_TERM, ';
v_sql32 := v_sql32||'      T2.LINS_UNSH_PRINCIPAL, ';
v_sql32 := v_sql32||'      T4.LINS_SH_UNPAY_PRINCIPAL_BIG, ';
v_sql32 := v_sql32||'      T4.LINS_SH_UNPAY_BAL, ';
v_sql32 := v_sql32||'      T2.LINS_STATUS, ';
v_sql32 := v_sql32||'      T3.APP_CORPTYPE, ';
v_sql32 := v_sql32||'      T4.MONTHLYPAYCC, ';
v_sql32 := v_sql32||'      CASE WHEN ';
v_sql32 := v_sql32||'        (T14.CURR_OVD_STATUS + 0) > T4.CURR_OVD_STATUS ';
v_sql32 := v_sql32||'           THEN  T14.CURR_OVD_STATUS ';
v_sql32 := v_sql32||'      ELSE  T4.CURR_OVD_STATUS ';
v_sql32 := v_sql32||'      END , ';
v_sql32 := v_sql32||'      T4.LINS_CUR_SH_AMT, ';
v_sql32 := v_sql32||'      T4.HISTUPDATEDLIMITTYPE, ';
v_sql32 := v_sql32||'      T5.LIMITUSAGE, ';
v_sql32 := v_sql32||'      T1.BRANCH, ';
v_sql32 := v_sql32||'      '' '', ';
v_sql32 := v_sql32||'      T4.TERMS, ';
v_sql32 := v_sql32||'      T7.EMPLOYERGEOCODE, ';
v_sql32 := v_sql32||'      CASE ';
v_sql32 := v_sql32||'         WHEN T10.LIMIT = 0 ';
v_sql32 := v_sql32||'         THEN ';
v_sql32 := v_sql32||'            0 ';
v_sql32 := v_sql32||'         ELSE ';
v_sql32 := v_sql32||'            CASE ';
v_sql32 := v_sql32||'               WHEN ROUND (T10.BAL / T10.LIMIT, 4) * 100 > 100 ';
v_sql32 := v_sql32||'               THEN ';
v_sql32 := v_sql32||'                  100 ';
v_sql32 := v_sql32||'               ELSE ';
v_sql32 := v_sql32||'                  ROUND (T10.BAL / T10.LIMIT, 4) * 100 ';
v_sql32 := v_sql32||'            END ';
v_sql32 := v_sql32||'      END , ';
v_sql32 := v_sql32||'      T5.STMTREPAYRATIO_L12M, ';
v_sql32 := v_sql32||'      T5.STMTRepayAveRatio_L12M, ';
v_sql32 := v_sql32||'      T4.STMTFEEACCOUR_L12M, ';
v_sql32 := v_sql32||'      T4.PAST12_GET_CASH_COUNT, ';
v_sql32 := v_sql32||'      T4.COLLECTTEMPLATE, ';
v_sql32 := v_sql32||'      T4.PAST12_MAX_DUE_MTHS, ';
v_sql32 := v_sql32||'      T4.STMTBALINCREASEMONTH_L12M, ';
v_sql32 := v_sql32||'      T4.PAST3_DUE_COUNT, ';
v_sql32 := v_sql32||'      CASE ';
v_sql32 := v_sql32||'         WHEN T8.LIMIT = 0 ';
v_sql32 := v_sql32||'         THEN ';
v_sql32 := v_sql32||'            0 ';
v_sql32 := v_sql32||'         ELSE ';
v_sql32 := v_sql32||'            CASE ';
v_sql32 := v_sql32||'               WHEN ROUND (T8.BAL / T8.LIMIT, 4) * 100 > 100 THEN 100 ';
v_sql32 := v_sql32||'               ELSE ROUND (T8.BAL / T8.LIMIT, 4) * 100 ';
v_sql32 := v_sql32||'            END ';
v_sql32 := v_sql32||'      END , ';
v_sql32 := v_sql32||'      T4.PAST3_CREDIT_USE_RATIO_MAX, ';
v_sql32 := v_sql32||'      T4.PAST3_PAY_AMT_MTHS, ';
v_sql32 := v_sql32||'      T4.LAST_3MON_CASH_TIMES_1, ';
v_sql32 := v_sql32||'      T4.LAST_3MON_CASH_TIMES_2, ';
v_sql32 := v_sql32||'      T4.LAST_3MON_CASH_TIMES_3, ';
v_sql32 := v_sql32||'      CASE ';
v_sql32 := v_sql32||'         WHEN T8.LIMIT_ADD14 = 0 ';
v_sql32 := v_sql32||'         THEN ';
v_sql32 := v_sql32||'            0 ';
v_sql32 := v_sql32||'         ELSE ';
v_sql32 := v_sql32||'            CASE ';
v_sql32 := v_sql32||'               WHEN ROUND (T8.BAL_ADD14 / T8.LIMIT_ADD14, 4) * 100 > ';
v_sql32 := v_sql32||'                       100 ';
v_sql32 := v_sql32||'               THEN ';
v_sql32 := v_sql32||'                  100 ';
v_sql32 := v_sql32||'               ELSE ';
v_sql32 := v_sql32||'                  ROUND (T8.BAL_ADD14 / T8.LIMIT_ADD14, 4) * 100 ';
v_sql32 := v_sql32||'            END ';
v_sql32 := v_sql32||'      END , ';
v_sql32 := v_sql32||'      T4.STMTCASHINCREASERATIO, ';
v_sql32 := v_sql32||'      T4.PAST3_GET_CASH_RATIO, ';
v_sql32 := v_sql32||'      T5.STMTUTILITY_AVE_L6M, ';
v_sql32 := v_sql32||'      T4.STMTREPAYRATIO10MONTH_L6M, ';
v_sql32 := v_sql32||'      T5.STMTREPAYRATIO_L6M, ';
v_sql32 := v_sql32||'      T5.POINTS_6M STMTREWARD_AVE_L6M, ';
v_sql32 := v_sql32||'      T4.STMTINCOME_AVE_L6M, ';
v_sql32 := v_sql32||'      T4.PAST6_FEE_COUNT, ';
v_sql32 := v_sql32||'      T4.STMTFEEINCREASEMONTH_L6M, ';
v_sql32 := v_sql32||'      T4.STMTSUMCASH_L6M, ';
v_sql32 := v_sql32||'      T4.STMTCASHADVANCEMONTH_L6M, ';
v_sql32 := v_sql32||'      T4.STMTSUMCONSUME_L6M, ';
v_sql32 := v_sql32||'      T4.PAST6_DUE_COUNT_MAX, ';
v_sql32 := v_sql32||'      COAL (T11.FLAG2, ''0'') , ';
v_sql32 := v_sql32||'      T3.MARRIAGE, ';
v_sql32 := v_sql32||'      T3.EDUCATION_LEVEL, ';
v_sql32 := v_sql32||'      T4.ARREARINCREASE_L12M, ';
v_sql32 := v_sql32||'      T4.LAST_12MON_CONSUME_AMT_1, ';
v_sql32 := v_sql32||'      T4.LAST_12MON_CONSUME_AMT_2, ';
v_sql32 := v_sql32||'      T4.LAST_12MON_CONSUME_AMT_3, ';
v_sql32 := v_sql32||'      T4.LAST_12MON_CONSUME_AMT_4, ';
v_sql32 := v_sql32||'      T4.LAST_12MON_CONSUME_AMT_5, ';
v_sql32 := v_sql32||'      T4.LAST_12MON_CONSUME_AMT_6, ';
v_sql32 := v_sql32||'      T4.LAST_12MON_CONSUME_AMT_7, ';
v_sql32 := v_sql32||'      T4.LAST_12MON_CONSUME_AMT_8, ';
v_sql32 := v_sql32||'      T4.LAST_12MON_CONSUME_AMT_9, ';
v_sql32 := v_sql32||'      T4.LAST_12MON_CONSUME_AMT_10, ';
v_sql32 := v_sql32||'      T4.LAST_12MON_CONSUME_AMT_11, ';
v_sql32 := v_sql32||'      T4.LAST_12MON_CONSUME_AMT_12, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_REPAYMENT_1, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_REPAYMENT_2, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_REPAYMENT_3, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_REPAYMENT_4, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_REPAYMENT_5, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_REPAYMENT_6, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_REPAYMENT_7, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_REPAYMENT_8, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_REPAYMENT_9, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_REPAYMENT_10, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_REPAYMENT_11, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_REPAYMENT_12, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_REPAYMENT_13, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_CASH_1, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_CASH_2, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_CASH_3, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_CASH_4, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_CASH_5, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_CASH_6, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_CASH_7, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_CASH_8, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_CASH_9, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_CASH_10, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_CASH_11, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_CASH_12, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_CASH_13, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_CREDIT_AMT_1, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_CREDIT_AMT_2, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_CREDIT_AMT_3, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_CREDIT_AMT_4, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_CREDIT_AMT_5, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_CREDIT_AMT_6, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_CREDIT_AMT_7, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_CREDIT_AMT_8, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_CREDIT_AMT_9, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_CREDIT_AMT_10, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_CREDIT_AMT_11, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_CREDIT_AMT_12, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_CREDIT_AMT_13, ';
v_sql32 := v_sql32||'      T4.LINS_SH_UNPAY_BAL_1, ';
v_sql32 := v_sql32||'      T4.LINS_SH_UNPAY_BAL_2, ';
v_sql32 := v_sql32||'      T4.LINS_SH_UNPAY_BAL_3, ';
v_sql32 := v_sql32||'      T4.LINS_SH_UNPAY_BAL_4, ';
v_sql32 := v_sql32||'      T4.LINS_SH_UNPAY_BAL_5, ';
v_sql32 := v_sql32||'      T4.LINS_SH_UNPAY_BAL_6, ';
v_sql32 := v_sql32||'      T4.LINS_SH_UNPAY_BAL_7, ';
v_sql32 := v_sql32||'      T4.LINS_SH_UNPAY_BAL_8, ';
v_sql32 := v_sql32||'      T4.LINS_SH_UNPAY_BAL_9, ';
v_sql32 := v_sql32||'      T4.LINS_SH_UNPAY_BAL_10, ';
v_sql32 := v_sql32||'      T4.LINS_SH_UNPAY_BAL_11, ';
v_sql32 := v_sql32||'      T4.LINS_SH_UNPAY_BAL_12, ';
v_sql32 := v_sql32||'      T4.LINS_SH_UNPAY_BAL_13, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_TEMP_AMT_1, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_TEMP_AMT_2, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_TEMP_AMT_3, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_TEMP_AMT_4, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_TEMP_AMT_5, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_TEMP_AMT_6, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_TEMP_AMT_7, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_TEMP_AMT_8, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_TEMP_AMT_9, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_TEMP_AMT_10, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_TEMP_AMT_11, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_TEMP_AMT_12, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_TEMP_AMT_13, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_BILL_AMT_1, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_BILL_AMT_2, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_BILL_AMT_3, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_BILL_AMT_4, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_BILL_AMT_5, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_BILL_AMT_6, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_BILL_AMT_7, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_BILL_AMT_8, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_BILL_AMT_9, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_BILL_AMT_10, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_BILL_AMT_11, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_BILL_AMT_12, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_BILL_AMT_13, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_LOWEST_REPAY_1, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_LOWEST_REPAY_2, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_LOWEST_REPAY_3, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_LOWEST_REPAY_4, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_LOWEST_REPAY_5, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_LOWEST_REPAY_6, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_LOWEST_REPAY_7, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_LOWEST_REPAY_8, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_LOWEST_REPAY_9, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_LOWEST_REPAY_10, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_LOWEST_REPAY_11, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_LOWEST_REPAY_12, ';
v_sql32 := v_sql32||'      T4.LAST_13MON_LOWEST_REPAY_13, ';
v_sql32 := v_sql32||'      T4.ARREARINCREASE_L24M, ';
v_sql32 := v_sql32||'    CASE WHEN  T4.LAST_24MON_OVD_FLAG_1 > ''0'' OR  T14.LAST_24MON_OVD_FLAG_1 > ''0'' ';
v_sql32 := v_sql32||'         THEN ''1'' ';
v_sql32 := v_sql32||'         ELSE ''0'' ';
v_sql32 := v_sql32||'    END , ';
v_sql32 := v_sql32||'    CASE WHEN  T4.LAST_24MON_OVD_FLAG_2 > ''0'' OR  T14.LAST_24MON_OVD_FLAG_2 > ''0'' ';
v_sql32 := v_sql32||'         THEN ''1'' ';
v_sql32 := v_sql32||'         ELSE ''0'' ';
v_sql32 := v_sql32||'    END , ';
v_sql32 := v_sql32||'    CASE WHEN  T4.LAST_24MON_OVD_FLAG_3 > ''0'' OR  T14.LAST_24MON_OVD_FLAG_3 > ''0'' ';
v_sql32 := v_sql32||'         THEN ''1'' ';
v_sql32 := v_sql32||'         ELSE ''0'' ';
v_sql32 := v_sql32||'    END , ';
v_sql32 := v_sql32||'    CASE WHEN  T4.LAST_24MON_OVD_FLAG_4 > ''0'' OR  T14.LAST_24MON_OVD_FLAG_4 > ''0'' ';
v_sql32 := v_sql32||'         THEN ''1'' ';
v_sql32 := v_sql32||'         ELSE ''0'' ';
v_sql32 := v_sql32||'    END , ';
v_sql32 := v_sql32||'    CASE WHEN  T4.LAST_24MON_OVD_FLAG_5 > ''0'' OR  T14.LAST_24MON_OVD_FLAG_5 > ''0'' ';
v_sql32 := v_sql32||'         THEN ''1'' ';
v_sql32 := v_sql32||'         ELSE ''0'' ';
v_sql32 := v_sql32||'    END , ';
v_sql32 := v_sql32||'    CASE WHEN  T4.LAST_24MON_OVD_FLAG_6 > ''0'' OR  T14.LAST_24MON_OVD_FLAG_6 > ''0'' ';
v_sql32 := v_sql32||'         THEN ''1'' ';
v_sql32 := v_sql32||'         ELSE ''0'' ';
v_sql32 := v_sql32||'    END , ';
v_sql32 := v_sql32||'    CASE WHEN  T4.LAST_24MON_OVD_FLAG_7 > ''0'' OR  T14.LAST_24MON_OVD_FLAG_7 > ''0'' ';
v_sql32 := v_sql32||'         THEN ''1'' ';
v_sql32 := v_sql32||'         ELSE ''0'' ';
v_sql32 := v_sql32||'    END , ';
v_sql32 := v_sql32||'    CASE WHEN  T4.LAST_24MON_OVD_FLAG_8 > ''0'' OR  T14.LAST_24MON_OVD_FLAG_8 > ''0'' ';
v_sql32 := v_sql32||'         THEN ''1'' ';
v_sql32 := v_sql32||'         ELSE ''0'' ';
v_sql32 := v_sql32||'    END , ';
v_sql32 := v_sql32||'    CASE WHEN  T4.LAST_24MON_OVD_FLAG_9 > ''0'' OR  T14.LAST_24MON_OVD_FLAG_9 > ''0'' ';
v_sql32 := v_sql32||'         THEN ''1'' ';
v_sql32 := v_sql32||'         ELSE ''0'' ';
v_sql32 := v_sql32||'    END , ';
v_sql32 := v_sql32||'    CASE WHEN  T4.LAST_24MON_OVD_FLAG_10 > ''0'' OR  T14.LAST_24MON_OVD_FLAG_10 > ''0'' ';
v_sql32 := v_sql32||'         THEN ''1'' ';
v_sql32 := v_sql32||'         ELSE ''0'' ';
v_sql32 := v_sql32||'    END , ';
v_sql32 := v_sql32||'    CASE WHEN  T4.LAST_24MON_OVD_FLAG_11 > ''0'' OR  T14.LAST_24MON_OVD_FLAG_11 > ''0'' ';
v_sql32 := v_sql32||'         THEN ''1'' ';
v_sql32 := v_sql32||'         ELSE ''0'' ';
v_sql32 := v_sql32||'    END , ';
v_sql32 := v_sql32||'    CASE WHEN  T4.LAST_24MON_OVD_FLAG_12 > ''0'' OR  T14.LAST_24MON_OVD_FLAG_12 > ''0'' ';
v_sql32 := v_sql32||'         THEN ''1'' ';
v_sql32 := v_sql32||'         ELSE ''0'' ';
v_sql32 := v_sql32||'    END , ';
v_sql32 := v_sql32||'      T4.LAST_24MON_OVD_FLAG_13, ';
v_sql32 := v_sql32||'      T4.LAST_24MON_OVD_FLAG_14, ';
v_sql32 := v_sql32||'      T4.LAST_24MON_OVD_FLAG_15, ';
v_sql32 := v_sql32||'      T4.LAST_24MON_OVD_FLAG_16, ';
v_sql32 := v_sql32||'      T4.LAST_24MON_OVD_FLAG_17, ';
v_sql32 := v_sql32||'      T4.LAST_24MON_OVD_FLAG_18, ';
v_sql32 := v_sql32||'      T4.LAST_24MON_OVD_FLAG_19, ';
v_sql32 := v_sql32||'      T4.LAST_24MON_OVD_FLAG_20, ';
v_sql32 := v_sql32||'      T4.LAST_24MON_OVD_FLAG_21, ';
v_sql32 := v_sql32||'      T4.LAST_24MON_OVD_FLAG_22, ';
v_sql32 := v_sql32||'      T4.LAST_24MON_OVD_FLAG_23, ';
v_sql32 := v_sql32||'      T4.LAST_24MON_OVD_FLAG_24, ';
v_sql32 := v_sql32||'      T4.LAST_6MON_INACTIVE_FLAG, ';
v_sql32 := v_sql32||'      T4.ARREARINCREASE_L6M, ';
v_sql32 := v_sql32||'      T1.CARD_ID, ';
v_sql32 := v_sql32||'      T1.RESULTREASONCODE, ';
v_sql32 := v_sql32||'      T1.CARD_BLOCK_CODES, ';
v_sql32 := v_sql32||'      T1.RISKGRADE, ';
v_sql32 := v_sql32||'      T1.OPENDATE, ';
v_sql32 := v_sql32||'      T3.APP_NATIONAL, ';
v_sql32 := v_sql32||'      T3.CUSTINDUSTRY, ';
v_sql32 := v_sql32||'      T1.RESTRICTIVETRADEFLAG, ';
v_sql32 := v_sql32||'      T1.SENDINGMETHOD, ';
v_sql32 := v_sql32||'      T1.CUSTTYPE, ';
v_sql32 := v_sql32||'      T1.TEMP_LIMIT, ';
v_sql32 := v_sql32||'      T1.ACCTBOSSAPPROVED, ';
v_sql32 := v_sql32||'      T3.ANNUAL_INCOME, ';
v_sql32 := v_sql32||'      T4.CHEAT_FLG, ';
v_sql32 := v_sql32||'      T4.ACCTCASHADVANCE, ';
v_sql32 := v_sql32||'      T1.HISTUPDATEDTYPE, ';
v_sql32 := v_sql32||'      COAL (T4.PRO_AMOUNT_LOAN_SME, 9999), ';
v_sql32 := v_sql32||'      T4.LAST_CYCLEDAY_CASH_TIMES, ';
v_sql32 := v_sql32||'      T1.APPTYPE, ';
v_sql32 := v_sql32||'      T1.AMOUNT, ';
v_sql32 := v_sql32||'      T1.APP_TERMS, ';
v_sql32 := v_sql32||'      T3.APPID, ';
v_sql32 := v_sql32||'      T3.MONTHLYSALARY, ';
v_sql32 := v_sql32||'      T3.IDISSUEDGEOCODE, ';
v_sql32 := v_sql32||'      T1.APP_APPDATE, ';
v_sql32 := v_sql32||'      T4.LINS_REM_UNSH_PRINCIPAL, ';
v_sql32 := v_sql32||'      T4.LINS_REM_UNSH_FEE, ';
v_sql32 := v_sql32||'      T1.APP_AUTODEBIT, ';
v_sql32 := v_sql32||'      T4.ANNUAL_FEE_OVD_FLAG, ';
v_sql32 := v_sql32||'      T1.DEATH_EXCLUDE_FLAG, ';
v_sql32 := v_sql32||'      T1.PRO_ACCTSTATUS_CC_EXISTING, ';
v_sql32 := v_sql32||'      T4.ACCTSTATUS, ';
v_sql32 := v_sql32||'      T1.SCORE, ';
v_sql32 := v_sql32||'      T1.HISTUPDATEDUPORDN, ';
v_sql32 := v_sql32||'      T3.RACE_TYPE, ';
v_sql32 := v_sql32||'      T4.LIMITCC, ';
v_sql32 := v_sql32||'      T4.APP_CCVALIDDATE, ';
v_sql32 := v_sql32||'      T4.PRO_STATUS_ACCT, ';
v_sql32 := v_sql32||'      T5.total_UsePre, ';
v_sql32 := v_sql32||'      T1.GENDER, ';
v_sql32 := v_sql32||'      T4.LINS_SH_UNPAY_PRINCIPAL, ';
v_sql32 := v_sql32||'      T5.BAL_WO_AUTHS, ';
v_sql32 := v_sql32||'      T4.CollectMethods, ';
v_sql32 := v_sql32||'      T1.CollectTimes, ';
v_sql32 := v_sql32||'      T3.CRED_LIMIT, ';
v_sql32 := v_sql32||'      T1.ACCTACCTLIMIT, ';
v_sql32 := v_sql32||'      T1.CYCLE_DAY_ONLY, ';
v_sql32 := v_sql32||'      T1.ACCTNUMB, ';
v_sql32 := v_sql32||'      T4.PBOC_ACCTNUMB_UTILIZATION50UP, ';
v_sql32 := v_sql32||'      T4.LAST_24MON_OVD_TERM_1, ';
v_sql32 := v_sql32||'      T4.LAST_24MON_OVD_TERM_2, ';
v_sql32 := v_sql32||'      T4.LAST_24MON_OVD_TERM_3, ';
v_sql32 := v_sql32||'      T4.LAST_24MON_OVD_TERM_4, ';
v_sql32 := v_sql32||'      T4.LAST_24MON_OVD_TERM_5, ';
v_sql32 := v_sql32||'      T4.LAST_24MON_OVD_TERM_6, ';
v_sql32 := v_sql32||'      T4.LAST_24MON_OVD_TERM_7, ';
v_sql32 := v_sql32||'      T4.LAST_24MON_OVD_TERM_8, ';
v_sql32 := v_sql32||'      T4.LAST_24MON_OVD_TERM_9, ';
v_sql32 := v_sql32||'      T4.LAST_24MON_OVD_TERM_10, ';
v_sql32 := v_sql32||'      T4.LAST_24MON_OVD_TERM_11, ';
v_sql32 := v_sql32||'      T4.LAST_24MON_OVD_TERM_12, ';
v_sql32 := v_sql32||'      T4.LAST_24MON_OVD_TERM_13, ';
v_sql32 := v_sql32||'      T4.LAST_24MON_OVD_TERM_14, ';
v_sql32 := v_sql32||'      T4.LAST_24MON_OVD_TERM_15, ';
v_sql32 := v_sql32||'      T4.LAST_24MON_OVD_TERM_16, ';
v_sql32 := v_sql32||'      T4.LAST_24MON_OVD_TERM_17, ';
v_sql32 := v_sql32||'      T4.LAST_24MON_OVD_TERM_18, ';
v_sql32 := v_sql32||'      T4.LAST_24MON_OVD_TERM_19, ';
v_sql32 := v_sql32||'      T4.LAST_24MON_OVD_TERM_20, ';
v_sql32 := v_sql32||'      T4.LAST_24MON_OVD_TERM_21, ';
v_sql32 := v_sql32||'      T4.LAST_24MON_OVD_TERM_22, ';
v_sql32 := v_sql32||'      T4.LAST_24MON_OVD_TERM_23, ';
v_sql32 := v_sql32||'      T4.LAST_24MON_OVD_TERM_24, ';
v_sql32 := v_sql32||'      CASE ';
v_sql32 := v_sql32||'         WHEN T9.LIMIT = 0 ';
v_sql32 := v_sql32||'         THEN ';
v_sql32 := v_sql32||'            0 ';
v_sql32 := v_sql32||'         ELSE ';
v_sql32 := v_sql32||'            CASE ';
v_sql32 := v_sql32||'               WHEN ROUND (T9.BAL / T9.LIMIT, 4) * 100 > 100 THEN 100 ';
v_sql32 := v_sql32||'               ELSE ROUND (T9.BAL / T9.LIMIT, 4) * 100 ';
v_sql32 := v_sql32||'            END ';
v_sql32 := v_sql32||'      END , ';
v_sql32 := v_sql32||'      T1.LAST_CUS_PERM_LINE_INC, ';
v_sql32 := v_sql32||'      T1.LAST_CUS_TEMP_LINE_ADJ, ';
v_sql32 := v_sql32||'      T1.LAST_BANK_PERM_LINE_INC, ';
v_sql32 := v_sql32||'      T1.LAST_BANK_TEMP_ADJ, ';
v_sql32 := v_sql32||'      T1.LAST_BILL_ADDRESS_CHANGE, ';
v_sql32 := v_sql32||'      T4.AC_LINS_FLG_ALL, ';
v_sql32 := v_sql32||'        CASE ';
v_sql32 := v_sql32||'           WHEN T3.YYYYMMDD_BIRTH IS NULL OR T3.YYYYMMDD_BIRTH = 0 ';
v_sql32 := v_sql32||'           THEN ';
v_sql32 := v_sql32||'              0 ';
v_sql32 := v_sql32||'           ELSE ';
v_sql32 := v_sql32||'              CEIL ( ';
v_sql32 := v_sql32||'                   date_diff(SYSDATE(),todate(T3.YYYYMMDD_BIRTH,''yyyy-mm-dd'')) ';
v_sql32 := v_sql32||'                 / 365) ';
v_sql32 := v_sql32||'        END, ';
v_sql32 := v_sql32||'      COAL (T4.PRO_AMOUNT_LOAN, 9999) , ';
v_sql32 := v_sql32||'      T4.NCSNDAMOUNT, ';
v_sql32 := v_sql32||'      T4.IANDAMOUNT, ';
v_sql32 := v_sql32||'      T4.DELAYAMOUNT6MON, ';
v_sql32 := v_sql32||'      T5.INTEREST6MON, ';
v_sql32 := v_sql32||'        CASE WHEN T4.LAST_12MON_CONSUME_AMT_1 > 0 THEN 1 ELSE 0 END ';
v_sql32 := v_sql32||'      + CASE WHEN T4.LAST_12MON_CONSUME_AMT_2 > 0 THEN 1 ELSE 0 END ';
v_sql32 := v_sql32||'      + CASE WHEN T4.LAST_12MON_CONSUME_AMT_3 > 0 THEN 1 ELSE 0 END, ';
v_sql32 := v_sql32||'      T5.BAL, ';
v_sql32 := v_sql32||'      T5.BAL_ADD14, ';
v_sql32 := v_sql32||'      T5.MAXPRODUCTLINE, ';
v_sql32 := v_sql32||'      toDate(ADD_MONTHS (toDate(t1.CYCLE_DATE, ''yyyy-mm-dd''), 1), ';
v_sql32 := v_sql32||'                  ''yyyymmdd''), ';
v_sql32 := v_sql32||'      CASE ';
v_sql32 := v_sql32||'         WHEN T1.LAST_CUS_TEMP_LINE_ADJ = 0 ';
v_sql32 := v_sql32||'         THEN ';
v_sql32 := v_sql32||'            9999 ';
v_sql32 := v_sql32||'         ELSE ';
v_sql32 := v_sql32||'          CEIL( date_diff(SYSDATE(),todate(T1.LAST_CUS_TEMP_LINE_ADJ,''yyyy-mm-dd'')) ) ';
v_sql32 := v_sql32||'      END, ';
v_sql32 := v_sql32||'      COAL (ADJ.LASTDELETEMON, 9999), ';
v_sql32 := v_sql32||'      COAL (ADJ.LASTINCREMONASE, 9999), ';
v_sql32 := v_sql32||'      COAL (ADJ.LASTBATCHDEMON, 9999), ';
v_sql32 := v_sql32||'      COAL (ADJ.LASTBATCHINMON, 9999), ';
v_sql32 := v_sql32||'      COAL (T4.PBOC_ACCTAGE_HIGHEST_HEALTHY,9999), ';
v_sql32 := v_sql32||'      0, ';
v_sql32 := v_sql32||'      CASE ';
v_sql32 := v_sql32||'         WHEN T11.FLAG3 = ''A'' ';
v_sql32 := v_sql32||'         THEN ';
v_sql32 := v_sql32||'            1 ';
v_sql32 := v_sql32||'         ELSE ';
v_sql32 := v_sql32||'            0 ';
v_sql32 := v_sql32||'      END , ';
v_sql32 := v_sql32||'      CASE ';
v_sql32 := v_sql32||'         WHEN T11.FLAG1 = ''A'' ';
v_sql32 := v_sql32||'         THEN ';
v_sql32 := v_sql32||'            1 ';
v_sql32 := v_sql32||'         ELSE ';
v_sql32 := v_sql32||'            0 ';
v_sql32 := v_sql32||'      END , ';
v_sql32 := v_sql32||'      0, ';
v_sql32 := v_sql32||'      0, ';
v_sql32 := v_sql32||'      0, ';
v_sql32 := v_sql32||'      0, ';
v_sql32 := v_sql32||'      t5.last3monavgrate, ';
v_sql32 := v_sql32||'      t7.MAIN_CARD_NBR, ';
v_sql32 := v_sql32||'      t7.MO_PHONE, ';
v_sql32 := v_sql32||'      T4.untrl_pc_amt, ';
v_sql32 := v_sql32||'      T4.untrl_bad_pc_amt, ';
v_sql32 := v_sql32||'      T4.untrl_ca_amt, ';
v_sql32 := v_sql32||'      T4.untrl_top3_amt, ';
v_sql32 := v_sql32||'      T4.untrl_mcht_sum_amt, ';
v_sql32 := v_sql32||'      T4.untrl_pc_counts, ';
v_sql32 := v_sql32||'      T4.untrl_pc_net_counts, ';
v_sql32 := v_sql32||'      T4.untrl_max_pc_amt, ';
v_sql32 := v_sql32||'      T4.untrl_pc_mcht_counts, ';
v_sql32 := v_sql32||'      T4.Res1 , ';
v_sql32 := v_sql32||'      T4.Res2 , ';
v_sql32 := v_sql32||'      T4.Res3 , ';
v_sql32 := v_sql32||'      T4.Res4 , ';
v_sql32 := v_sql32||'      T4.Res5 , ';
v_sql32 := v_sql32||'      T4.Res6 , ';
v_sql32 := v_sql32||'      T4.Res7 , ';
v_sql32 := v_sql32||'      floor (months_between (toDate(T1.CYCLE_DATE,''yyyy-mm-dd'') , toDate(T4.Res7,''yyyy-mm-dd''))) + 1 , ';
v_sql32 := v_sql32||'      T4.Res9 , ';
v_sql32 := v_sql32||'      T4.Res10, ';
v_sql32 := v_sql32||'      T4.Res11, ';
v_sql32 := v_sql32||'      T4.Res12, ';
v_sql32 := v_sql32||'      T4.Res13, ';
v_sql32 := v_sql32||'      T4.Res14, ';
v_sql32 := v_sql32||'      T4.Res15, ';
v_sql32 := v_sql32||'      T4.Res16, ';
v_sql32 := v_sql32||'      T14.last_13mon_bill_amt_1 ';
v_sql32 := v_sql32||'      + T14.last_13mon_bill_amt_2  ';
v_sql32 := v_sql32||'      + T14.last_13mon_bill_amt_3  ';
v_sql32 := v_sql32||'      + T14.last_13mon_bill_amt_4  ';
v_sql32 := v_sql32||'      + T14.last_13mon_bill_amt_5  ';
v_sql32 := v_sql32||'      + T14.last_13mon_bill_amt_6, ';
v_sql32 := v_sql32||'      T15.BAL_ADD14, ';
v_sql32 := v_sql32||'      T14.EXTRACTTYPE, ';
v_sql32 := v_sql32||'      T4.Res20, ';
v_sql32 := v_sql32||'      T4.Res21, ';
v_sql32 := v_sql32||'      T4.Res22, ';
v_sql32 := v_sql32||'      T4.Res23, ';
v_sql32 := v_sql32||'      T4.Res24, ';
v_sql32 := v_sql32||'      T4.Res25, ';
v_sql32 := v_sql32||'      T4.Res26, ';
v_sql32 := v_sql32||'      T4.Res27, ';
v_sql32 := v_sql32||'      T4.Res28, ';
v_sql32 := v_sql32||'      T4.Res29, ';
v_sql32 := v_sql32||'      T4.Res30, ';
v_sql32 := v_sql32||'      T4.Res31, ';
v_sql32 := v_sql32||'      T4.Res32, ';
v_sql32 := v_sql32||'      T4.Res33, ';
v_sql32 := v_sql32||'      T4.Res34, ';
v_sql32 := v_sql32||'      T4.Res35, ';
v_sql32 := v_sql32||'      T4.Res36, ';
v_sql32 := v_sql32||'      T4.Res37, ';
v_sql32 := v_sql32||'      T4.Res38, ';
v_sql32 := v_sql32||'      T4.Res39, ';
v_sql32 := v_sql32||'      T4.Res40, ';
v_sql32 := v_sql32||'      T4.Res41, ';
v_sql32 := v_sql32||'      T4.Res42, ';
v_sql32 := v_sql32||'      T4.Res43, ';
v_sql32 := v_sql32||'      T4.Res44, ';
v_sql32 := v_sql32||'      T4.Res45, ';
v_sql32 := v_sql32||'      T4.Res46, ';
v_sql32 := v_sql32||'      T4.Res47, ';
v_sql32 := v_sql32||'      T4.Res48, ';
v_sql32 := v_sql32||'      T4.Res49, ';
v_sql32 := v_sql32||'      T4.Res50, ';
v_sql32 := v_sql32||'      T4.Res51, ';
v_sql32 := v_sql32||'      T4.Res52, ';
v_sql32 := v_sql32||'      T4.Res53, ';
v_sql32 := v_sql32||'      T4.Res54, ';
v_sql32 := v_sql32||'      T4.Res55, ';
v_sql32 := v_sql32||'      T4.Res56, ';
v_sql32 := v_sql32||'      T4.Res57, ';
v_sql32 := v_sql32||'      T4.Res58, ';
v_sql32 := v_sql32||'      T4.Res59, ';
v_sql32 := v_sql32||'      T4.Res60, ';
v_sql32 := v_sql32||'      T4.Res61, ';
v_sql32 := v_sql32||'      T4.Res62, ';
v_sql32 := v_sql32||'      T4.Res63, ';
v_sql32 := v_sql32||'      T4.Res64, ';
v_sql32 := v_sql32||'      T4.Res65, ';
v_sql32 := v_sql32||'      T4.Res66, ';
v_sql32 := v_sql32||'      T4.Res67, ';
v_sql32 := v_sql32||'      T4.Res68  ';
v_sql32 := v_sql32||' FROM temp_main_account t1 ';
v_sql32 := v_sql32||'      LEFT JOIN ';
v_sql32 := v_sql32||'      (SELECT ta.* ';
v_sql32 := v_sql32||'         FROM (SELECT t1.CURR_TERM, ';
v_sql32 := v_sql32||'                      t1.CU_LINS_CUR_FLG, ';
v_sql32 := v_sql32||'                      t1.LINS_DATE_END, ';
v_sql32 := v_sql32||'                      t1.LINS_DATE_ST, ';
v_sql32 := v_sql32||'                      t1.LINS_TYPE, ';
v_sql32 := v_sql32||'                      t1.LINS_TERM, ';
v_sql32 := v_sql32||'                      t1.LINS_REM_TERM, ';
v_sql32 := v_sql32||'                      t1.LINS_UNSH_PRINCIPAL, ';
v_sql32 := v_sql32||'                      t1.LINS_STATUS, ';
v_sql32 := v_sql32||'                      t1.custnum, ';
v_sql32 := v_sql32||'                      ROW_NUMBER () ';
v_sql32 := v_sql32||'                      OVER (PARTITION BY CUSTNUM ';
v_sql32 := v_sql32||'                            ORDER BY (LINS_DATE_ST + 0) DESC) ';
v_sql32 := v_sql32||'                         AS cn ';
v_sql32 := v_sql32||'                 FROM account t1 ';
v_sql32 := v_sql32||'                WHERE coal(LINS_DATE_ST,'' '') <> 0) ta ';
v_sql32 := v_sql32||'        WHERE ta.cn = 1) t2 ';
v_sql32 := v_sql32||'         ON T2.CUSTNUM = T1.CUSTNUM ';
v_sql32 := v_sql32||'      LEFT JOIN MDM_CUSTR_INFO t3 ';
v_sql32 := v_sql32||'                                 ON T1.ACCTNUM = T3.XACCOUNT ';
v_sql32 := v_sql32||'      LEFT JOIN temp_main_basic t4 ';
v_sql32 := v_sql32||'                                  ON T1.CUSTNUM = T4.CUSTNUM ';
v_sql32 := v_sql32||'      LEFT JOIN temp_custum_special t5 ';
v_sql32 := v_sql32||'                                      ON T1.CUSTNUM = T5.CUSTR_NBR ';
v_sql32 := v_sql32||'      LEFT JOIN MDM_CARD_CUSTR_INFO T7 ';
v_sql32 := v_sql32||'                                      ON T1.ACCTNUM = T7.XACCOUNT ';
v_sql32 := v_sql32||'      LEFT JOIN TEMP_CUSTNUM_LIMITUSAGE T8 ';
v_sql32 := v_sql32||'         ON T8.MONTHS = 3 AND t8.CUSTNUM = t1.CUSTNUM ';
v_sql32 := v_sql32||'      LEFT JOIN TEMP_CUSTNUM_LIMITUSAGE T9 ';
v_sql32 := v_sql32||'         ON T9.MONTHS = 6 AND t9.CUSTNUM = t1.CUSTNUM ';
v_sql32 := v_sql32||'      LEFT JOIN TEMP_CUSTNUM_LIMITUSAGE T10 ';
v_sql32 := v_sql32||'         ON T10.MONTHS = 12 AND t10.CUSTNUM = t1.CUSTNUM ';
v_sql32 := v_sql32||'      LEFT JOIN TEMP_CUSTUM_FLAG T11 ';
v_sql32 := v_sql32||'         ON T11.CUSTR_NBR = T1.CUSTNUM ';
v_sql32 := v_sql32||'      LEFT JOIN ( SELECT t.* FROM MATCHRESULT t,tbl_banks tc WHERE t.bankid = tc.bankid ) T12 ';
v_sql32 := v_sql32||'         ON T12.CUSTNUM = T1.CUSTNUM ';
v_sql32 := v_sql32||'      LEFT JOIN (  SELECT adjtemp.CUSTR_NBR CUSTR_NBR, ';
v_sql32 := v_sql32||'                          MIN (adjtemp.lastdeletemon + 0) lastdeletemon, ';
v_sql32 := v_sql32||'                          MIN (adjtemp.lastincremonase + 0) lastincremonase, ';
v_sql32 := v_sql32||'                          MIN (adjtemp.lastbatchdemon +  0) lastbatchdemon, ';
v_sql32 := v_sql32||'                          MIN (adjtemp.lastbatchinmon + 0) lastbatchinmon ';
v_sql32 := v_sql32||'                     FROM MDM_LIMIT_ADJ_INFO adjtemp ';
v_sql32 := v_sql32||'                 GROUP BY ADJTemp.CUSTR_NBR) adj ';
v_sql32 := v_sql32||'         ON ADJ.CUSTR_NBR = T1.CUSTNUM ';
v_sql32 := v_sql32||'      LEFT JOIN ';
v_sql32 := v_sql32||'      (SELECT tb.* ';
v_sql32 := v_sql32||'         FROM (SELECT t1.CURR_TERM, ';
v_sql32 := v_sql32||'                      t1.CU_LINS_CUR_FLG, ';
v_sql32 := v_sql32||'                      t1.LINS_DATE_END, ';
v_sql32 := v_sql32||'                      t1.LINS_DATE_ST, ';
v_sql32 := v_sql32||'                      t1.LINS_TYPE, ';
v_sql32 := v_sql32||'                      t1.LINS_TERM, ';
v_sql32 := v_sql32||'                      t1.LINS_REM_TERM, ';
v_sql32 := v_sql32||'                      t1.LINS_UNSH_PRINCIPAL, ';
v_sql32 := v_sql32||'                      t1.LINS_STATUS, ';
v_sql32 := v_sql32||'                      t1.custnum, ';
v_sql32 := v_sql32||'                      ROW_NUMBER () ';
v_sql32 := v_sql32||'                      OVER (PARTITION BY CUSTNUM ';
v_sql32 := v_sql32||'                            ORDER BY (LINS_DATE_ST + 0) DESC) ';
v_sql32 := v_sql32||'                         AS cn ';
v_sql32 := v_sql32||'                 FROM account_sp t1 ';
v_sql32 := v_sql32||'                WHERE coal(LINS_DATE_ST,'' '') <> 0) tb';
v_sql32 := v_sql32||'        WHERE tb.cn = 1) t13 ';
v_sql32 := v_sql32||'         ON T13.CUSTNUM = T1.CUSTNUM ';
v_sql32 := v_sql32||'        LEFT JOIN temp_main_basic_SP t14 ';
v_sql32 := v_sql32||'                 ON T1.CUSTNUM = T14.CUSTNUM ';
v_sql32 := v_sql32||'        LEFT JOIN temp_custum_special_sp t15 ';
v_sql32 := v_sql32||'                 ON T1.CUSTNUM = T15.CUSTR_NBR ';

    DBMS_OUTPUT.PUT_LINE('CUSTNUM after:==========' || v_sql32);

    execute immediate v_sql32;
 
    DBMS_OUTPUT.PUT_LINE('CUSTNUM over:==========success!');

    SET RESULT = '1';
END;

DECLARE RESULT_OUT STRING;
DECLARE ETL_DATE STRING = '2015-12-15 00:00:00';
call PRC_CUSTUM(ETL_DATE, RESULT_OUT);
PRING RESULT_OUT;